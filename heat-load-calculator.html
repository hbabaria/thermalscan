<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ThermalScan v4 ‚Äî Heat Load Calculator</title>
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
:root{--bg:#0a0c0f;--sf:#111318;--sf2:#1a1d24;--bd:#252830;--bd2:#2e3240;--ac:#f97316;--ac2:#fb923c;--acd:rgba(249,115,22,0.15);--acg:rgba(249,115,22,0.4);--tx:#e8eaf0;--tx2:#8b90a0;--tx3:#555a6a;--gn:#22c55e;--bl:#3b82f6;--rd:#ef4444;--yl:#eab308;--mn:'Space Mono',monospace;--ss:'DM Sans',sans-serif}
*{box-sizing:border-box;margin:0;padding:0}
body{background:var(--bg);color:var(--tx);font-family:var(--ss);min-height:100vh;overflow-x:hidden}
body::before{content:'';position:fixed;inset:0;background-image:linear-gradient(rgba(249,115,22,0.03)1px,transparent 1px),linear-gradient(90deg,rgba(249,115,22,0.03)1px,transparent 1px);background-size:40px 40px;pointer-events:none;z-index:0}
header{position:relative;z-index:10;border-bottom:1px solid var(--bd);padding:0 32px;display:flex;align-items:center;justify-content:space-between;height:60px;background:rgba(10,12,15,0.95);backdrop-filter:blur(12px)}
.logo{display:flex;align-items:center;gap:10px;font-family:var(--mn);font-size:17px;font-weight:700;letter-spacing:-0.5px}
.logo-icon{width:30px;height:30px;background:var(--ac);border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:14px}
.logo span{color:var(--ac)}
.hdr-r{display:flex;gap:8px;align-items:center}
.hbadge{font-family:var(--mn);font-size:10px;color:var(--tx2);background:var(--sf2);border:1px solid var(--bd2);padding:3px 9px;border-radius:20px;letter-spacing:1px}
.app{position:relative;z-index:1;max-width:1240px;margin:0 auto;padding:36px 20px 20px}
.hero{text-align:center;margin-bottom:32px}
.hero-tag{display:inline-flex;align-items:center;gap:8px;font-family:var(--mn);font-size:11px;color:var(--ac);letter-spacing:2px;text-transform:uppercase;margin-bottom:12px;padding:5px 13px;border:1px solid var(--acd);border-radius:20px;background:var(--acd)}
.hero h1{font-family:var(--mn);font-size:clamp(26px,4vw,44px);font-weight:700;line-height:1.1;letter-spacing:-1px;margin-bottom:12px}
.hero h1 span{color:var(--ac)}
.hero p{color:var(--tx2);font-size:15px;max-width:640px;margin:0 auto;line-height:1.7}
.steps{display:flex;align-items:center;justify-content:center;margin-bottom:32px;font-family:var(--mn);font-size:11px;flex-wrap:wrap;gap:4px}
.step{display:flex;align-items:center;gap:7px;color:var(--tx3);transition:color 0.3s}
.step.active{color:var(--ac)}.step.done{color:var(--gn)}
.step-num{width:26px;height:26px;border-radius:50%;border:1px solid currentColor;display:flex;align-items:center;justify-content:center;font-size:10px;flex-shrink:0}
.step.active .step-num{background:var(--ac);border-color:var(--ac);color:white}
.step.done .step-num{background:var(--gn);border-color:var(--gn);color:white}
.step-line{width:28px;height:1px;background:var(--bd2)}
.tab-bar{display:flex;gap:2px;background:var(--sf2);border:1px solid var(--bd);border-radius:10px;padding:4px;margin-bottom:20px}
.tab-btn{flex:1;padding:8px 12px;border:none;background:transparent;color:var(--tx2);font-family:var(--mn);font-size:12px;border-radius:7px;cursor:pointer;transition:all 0.2s}
.tab-btn.active{background:var(--ac);color:white}
.tab-btn:hover:not(.active){background:var(--bd);color:var(--tx)}
.upload-zone{border:2px dashed var(--bd2);border-radius:14px;padding:44px 32px;text-align:center;cursor:pointer;transition:all 0.3s;background:var(--sf);position:relative;overflow:hidden}
.upload-zone::before{content:'';position:absolute;inset:0;background:radial-gradient(circle at 50% 50%,var(--acd),transparent 70%);opacity:0;transition:opacity 0.3s}
.upload-zone:hover,.upload-zone.dragover{border-color:var(--ac);transform:translateY(-2px)}
.upload-zone:hover::before,.upload-zone.dragover::before{opacity:1}
.upload-icon{font-size:40px;margin-bottom:12px;display:block}
.upload-zone h3{font-family:var(--mn);font-size:16px;margin-bottom:7px}
.upload-zone p{color:var(--tx2);font-size:13px;margin-top:4px}
.upload-formats{display:flex;gap:6px;justify-content:center;margin-top:14px;flex-wrap:wrap}
.fmt-badge{font-family:var(--mn);font-size:10px;letter-spacing:1px;padding:3px 9px;border-radius:4px;border:1px solid var(--bd2);color:var(--tx3)}
.cfg{background:var(--sf);border:1px solid var(--bd);border-radius:14px;padding:24px 28px;margin-top:20px}
.slbl{font-family:var(--mn);font-size:11px;letter-spacing:2px;text-transform:uppercase;color:var(--ac);margin-bottom:16px;display:flex;align-items:center;gap:8px}
.slbl::after{content:'';flex:1;height:1px;background:var(--bd)}
.fgrid{display:grid;grid-template-columns:repeat(auto-fit,minmax(190px,1fr));gap:14px}
.ff label{display:block;font-family:var(--mn);font-size:10px;letter-spacing:1px;color:var(--tx2);text-transform:uppercase;margin-bottom:5px}
.ff input,.ff select{width:100%;background:var(--sf2);border:1px solid var(--bd2);border-radius:7px;padding:9px 12px;color:var(--tx);font-family:var(--mn);font-size:12px;outline:none;transition:border-color 0.2s;-webkit-appearance:none}
.ff input:focus,.ff select:focus{border-color:var(--ac)}
.ze{background:var(--sf2);border:1px solid var(--bd2);border-radius:10px;padding:16px;margin-top:16px}
.ze-hdr{display:grid;grid-template-columns:1.6fr .9fr .9fr .9fr .9fr .7fr 36px;gap:6px;font-family:var(--mn);font-size:9px;letter-spacing:1px;text-transform:uppercase;color:var(--tx3);padding-bottom:8px;border-bottom:1px solid var(--bd2);margin-bottom:8px}
.zrow{display:grid;grid-template-columns:1.6fr .9fr .9fr .9fr .9fr .7fr 36px;gap:6px;align-items:center;margin-bottom:6px}
.zdel{width:32px;height:32px;border:1px solid var(--bd2);background:transparent;border-radius:6px;color:var(--tx3);cursor:pointer;font-size:14px;display:flex;align-items:center;justify-content:center;transition:all 0.2s}
.zdel:hover{border-color:var(--rd);color:var(--rd)}
.add-zone{display:inline-flex;align-items:center;gap:6px;font-family:var(--mn);font-size:11px;color:var(--ac);background:var(--acd);border:1px solid rgba(249,115,22,0.3);border-radius:6px;padding:6px 14px;cursor:pointer;margin-top:8px}
.sp{background:var(--sf2);border:1px solid var(--bd2);border-radius:12px;padding:18px 22px;margin-top:18px;display:none}
.sp.vis{display:block}
.sg{display:grid;grid-template-columns:repeat(5,1fr);gap:8px}
.sc{background:var(--sf);border:1px solid var(--bd);border-radius:7px;padding:10px;text-align:center}
.sc-dir{font-family:var(--mn);font-size:9px;letter-spacing:2px;color:var(--tx3);margin-bottom:5px}
.sc-val{font-family:var(--mn);font-size:18px;font-weight:700}
.sc-unit{font-family:var(--mn);font-size:9px;color:var(--tx3);margin-top:2px}
.sc-bar{height:3px;background:var(--bd);border-radius:2px;margin-top:7px;overflow:hidden}
.sc-fill{height:100%;border-radius:2px}
.ci{display:flex;flex-wrap:wrap;gap:10px;margin-top:12px;padding-top:12px;border-top:1px solid var(--bd);font-family:var(--mn);font-size:10px;color:var(--tx2)}
.ci strong{color:var(--ac)}
.pkm{font-family:var(--mn);font-size:10px;color:var(--ac);margin-bottom:8px}
.bars{display:flex;align-items:flex-end;gap:2px;height:80px}
.bw{flex:1;display:flex;flex-direction:column;align-items:center;gap:2px}
.bar{width:100%;border-radius:2px 2px 0 0;min-height:2px;cursor:pointer;position:relative}
.bar:hover::after{content:attr(data-tip);position:absolute;bottom:110%;left:50%;transform:translateX(-50%);background:var(--sf2);border:1px solid var(--bd2);border-radius:4px;padding:3px 7px;font-family:var(--mn);font-size:10px;color:var(--tx);white-space:nowrap;z-index:10}
.blbl{font-family:var(--mn);font-size:9px;color:var(--tx3)}
.baxis{display:flex;justify-content:space-between;margin-top:4px}
.baxis span{font-family:var(--mn);font-size:9px;color:var(--tx3)}
.btn{display:inline-flex;align-items:center;gap:8px;padding:10px 20px;border-radius:9px;border:none;cursor:pointer;font-family:var(--mn);font-size:12px;font-weight:700;transition:all 0.2s}
.btn-p{background:var(--ac);color:white}
.btn-p:hover{background:var(--ac2);transform:translateY(-1px);box-shadow:0 8px 24px var(--acg)}
.btn-p:disabled{opacity:0.4;cursor:not-allowed;transform:none;box-shadow:none}
.btn-g{background:transparent;color:var(--tx2);border:1px solid var(--bd2)}
.btn-g:hover{border-color:var(--ac);color:var(--ac)}
.brow{display:flex;gap:10px;margin-top:20px;align-items:center;justify-content:flex-end;flex-wrap:wrap}
.ap{background:var(--sf);border:1px solid var(--bd);border-radius:14px;padding:32px}
.pi{display:flex;align-items:flex-start;gap:14px;opacity:.3;transition:opacity .4s;margin-bottom:14px}
.pi.active{opacity:1}.pi.done{opacity:.7}
.pi-ico{width:34px;height:34px;border-radius:7px;background:var(--sf2);border:1px solid var(--bd2);display:flex;align-items:center;justify-content:center;font-size:15px;flex-shrink:0}
.pi.active .pi-ico{background:var(--acd);border-color:var(--ac);animation:pu 1.5s ease-in-out infinite}
.pi.done .pi-ico{background:rgba(34,197,94,.15);border-color:var(--gn)}
@keyframes pu{0%,100%{box-shadow:0 0 0 0 var(--acg)}50%{box-shadow:0 0 0 8px transparent}}
.pi-txt h4{font-family:var(--mn);font-size:12px;margin-bottom:3px}
.pi-txt p{font-size:12px;color:var(--tx2);line-height:1.5}
.dg{display:grid;grid-template-columns:repeat(auto-fit,minmax(265px,1fr));gap:14px;margin-bottom:20px}
.dc{background:var(--sf);border:1px solid var(--bd);border-radius:11px;padding:18px;position:relative;overflow:hidden}
.dc::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:var(--ac)}
.dc-lbl{font-family:var(--mn);font-size:9px;letter-spacing:2px;text-transform:uppercase;color:var(--tx3);margin-bottom:12px}
.dr{display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid var(--bd);gap:8px}
.dr:last-child{border-bottom:none}
.dk{font-size:12px;color:var(--tx2);flex:1}
.dv{font-family:var(--mn);font-size:12px;text-align:right}
.dv.ed{background:var(--sf2);border:1px solid var(--bd2);border-radius:4px;padding:2px 6px;outline:none;min-width:70px;transition:border-color .2s}
.dv.ed:focus{border-color:var(--ac)}
.rh{background:linear-gradient(135deg,var(--sf) 0%,#1a1410 100%);border:1px solid var(--ac);border-radius:14px;padding:32px;text-align:center;margin-bottom:20px;position:relative;overflow:hidden}
.rh::before{content:'';position:absolute;inset:0;background:radial-gradient(circle at 50% 100%,var(--acd),transparent 60%)}
.rhc{position:relative;z-index:1}
.rlbl{font-family:var(--mn);font-size:10px;letter-spacing:3px;text-transform:uppercase;color:var(--ac);margin-bottom:10px}
.rval{font-family:var(--mn);font-size:clamp(44px,7vw,72px);font-weight:700;color:white;line-height:1}
.runit{font-family:var(--mn);font-size:22px;color:var(--ac)}
.rsub{font-size:13px;color:var(--tx2);margin-top:10px}
.rmeta{display:flex;flex-wrap:wrap;gap:8px;justify-content:center;margin-top:12px}
.rtag{font-family:var(--mn);font-size:10px;padding:3px 10px;border-radius:20px;border:1px solid var(--bd2);color:var(--tx2);background:rgba(255,255,255,.03)}
.rtag strong{color:var(--ac)}
.bkg{display:grid;grid-template-columns:repeat(auto-fit,minmax(165px,1fr));gap:12px;margin-bottom:20px}
.bkc{background:var(--sf);border:1px solid var(--bd);border-radius:11px;padding:16px;text-align:center}
.bkc-i{font-size:20px;margin-bottom:6px}
.bkc-l{font-size:11px;color:var(--tx2);margin-bottom:6px}
.bkc-v{font-family:var(--mn);font-size:20px;font-weight:700}
.bkc-u{font-family:var(--mn);font-size:10px;color:var(--tx3)}
.bkc-b{height:3px;background:var(--bd);border-radius:2px;margin-top:10px;overflow:hidden}
.bkc-bf{height:100%;border-radius:2px;transition:width 1s}
.tw{background:var(--sf);border:1px solid var(--bd);border-radius:11px;overflow:hidden;margin-bottom:20px;overflow-x:auto}
.dt{width:100%;border-collapse:collapse;font-size:11px;min-width:540px}
.dt th{font-family:var(--mn);font-size:9px;letter-spacing:1.5px;text-transform:uppercase;color:var(--tx3);padding:9px 12px;text-align:left;border-bottom:1px solid var(--bd);background:var(--sf2)}
.dt td{padding:9px 12px;border-bottom:1px solid var(--bd);color:var(--tx);font-family:var(--mn);font-size:11px}
.dt tr:last-child td{border-bottom:none}
.dt tr:hover td{background:rgba(249,115,22,.04)}
.dt th.c,.dt td.c{text-align:center}
.trbdg{display:inline-flex;background:var(--acd);color:var(--ac);border:1px solid rgba(249,115,22,.3);border-radius:4px;padding:2px 7px;font-family:var(--mn);font-size:11px}
.hc{display:inline-block;padding:2px 7px;border-radius:4px;font-size:10px}
.hl{background:rgba(34,197,94,.15);color:var(--gn)}.hm{background:rgba(234,179,8,.15);color:var(--yl)}
.hh{background:rgba(249,115,22,.15);color:var(--ac)}.hvh{background:rgba(239,68,68,.15);color:var(--rd)}
.rl{display:flex;flex-direction:column;gap:10px;margin-bottom:20px}
.ri{background:var(--sf);border:1px solid var(--bd);border-radius:9px;padding:14px 18px;display:flex;gap:14px;align-items:flex-start}
.ri-i{font-size:18px;flex-shrink:0;margin-top:2px}
.ri-t h5{font-size:13px;font-weight:600;margin-bottom:3px}
.ri-t p{font-size:12px;color:var(--tx2);line-height:1.5}
.sav{margin-left:auto;flex-shrink:0;font-family:var(--mn);font-size:10px;color:var(--gn);background:rgba(34,197,94,.1);border:1px solid rgba(34,197,94,.3);border-radius:4px;padding:3px 7px;white-space:nowrap}
.snote{background:var(--sf2);border:1px solid var(--bd2);border-left:3px solid var(--ac);border-radius:7px;padding:14px 18px;font-size:12px;color:var(--tx2);line-height:1.7;margin-bottom:20px}
.iprev{background:var(--sf2);border:1px solid var(--bd);border-radius:11px;overflow:hidden;margin-bottom:20px;position:relative}
.iprev img{width:100%;max-height:300px;object-fit:contain;display:block}
.pov{position:absolute;inset:0;background:linear-gradient(to top,rgba(10,12,15,.8),transparent 40%);pointer-events:none}
.plbl{position:absolute;bottom:10px;left:14px;font-family:var(--mn);font-size:10px;color:var(--tx2)}
.toast{position:fixed;bottom:20px;right:20px;background:var(--sf2);border:1px solid var(--bd2);border-radius:9px;padding:12px 18px;font-family:var(--mn);font-size:12px;z-index:100;transform:translateY(80px);opacity:0;transition:all .3s}
.toast.show{transform:translateY(0);opacity:1}
#fileInput{display:none}.hidden{display:none!important}
.fade-in{animation:fi .4s ease forwards}
@keyframes fi{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
footer{position:relative;z-index:1;border-top:1px solid var(--bd);text-align:center;padding:18px;margin-top:32px}
.hs{background:var(--sf);border:1px solid var(--bd);border-radius:11px;padding:18px 22px;margin-bottom:20px}
.dlbtns{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end;margin-bottom:14px}
.dlb{background:var(--sf2);border:1px solid var(--bd2);color:var(--tx);padding:9px 16px;border-radius:7px;cursor:pointer;font-family:var(--mn);font-size:11px;display:inline-flex;align-items:center;gap:7px;transition:all .2s}
.dlb:hover{border-color:var(--ac);color:var(--ac)}
.dlb.pdf{border-color:rgba(239,68,68,.4);color:var(--rd)}.dlb.pdf:hover{background:rgba(239,68,68,.1)}
.spin{display:inline-block;width:12px;height:12px;border:2px solid currentColor;border-top-color:transparent;border-radius:50%;animation:sp .6s linear infinite}
@keyframes sp{to{transform:rotate(360deg)}}
.cbc{background:var(--sf);border:1px solid var(--bd);border-radius:12px;overflow:hidden;margin-bottom:12px}
.cbh{display:flex;align-items:center;justify-content:space-between;padding:14px 20px;cursor:pointer}
.cbh:hover{background:rgba(249,115,22,.05)}
.cbt{font-family:var(--mn);font-size:13px;font-weight:700;display:flex;align-items:center;gap:10px}
.cbbdg{font-family:var(--mn);font-size:10px;padding:2px 8px;border-radius:4px;background:var(--acd);color:var(--ac);border:1px solid rgba(249,115,22,.3)}
.cbb{padding:0 20px 20px;border-top:1px solid var(--bd);display:none}
.cbb.open{display:block}
.add-bld{display:inline-flex;align-items:center;gap:8px;font-family:var(--mn);font-size:12px;color:var(--gn);background:rgba(34,197,94,.1);border:1px solid rgba(34,197,94,.3);border-radius:8px;padding:9px 18px;cursor:pointer;margin-bottom:16px}
.crg{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:12px;margin-bottom:20px}
.crc{background:var(--sf);border:1px solid var(--bd);border-radius:11px;padding:16px;position:relative;overflow:hidden}
.cr-tr{font-family:var(--mn);font-size:28px;font-weight:700;margin:8px 0 4px}
</style>
</head>
<body>
<header>
  <div class="logo"><div class="logo-icon">üå°</div>Thermal<span>Scan</span></div>
  <div class="hdr-r">
    <div class="hbadge">OPEN-METEO + PVGIS + BLANCO-MURIEL</div>
    <div class="hbadge">ISHRAE ¬∑ NBC PART 8</div>
  </div>
</header>
<div class="app">
  <div class="hero">
    <div class="hero-tag">‚ö° AI-Powered MEP Tool v4</div>
    <h1>Heat Load<br><span>from CAD Drawings</span></h1>
    <p>Single building or entire campus. Custom zone editor, live solar from Open-Meteo ERA5 &amp; PVGIS-SARAH3, and professional PDF report export.</p>
  </div>
  <div class="steps" id="stepIndicator">
    <div class="step active" id="step1"><div class="step-num">1</div><span>Mode &amp; Upload</span></div>
    <div class="step-line"></div>
    <div class="step" id="step2"><div class="step-num">2</div><span>Configure</span></div>
    <div class="step-line"></div>
    <div class="step" id="step3"><div class="step-num">3</div><span>AI Analysis</span></div>
    <div class="step-line"></div>
    <div class="step" id="step4"><div class="step-num">4</div><span>Review</span></div>
    <div class="step-line"></div>
    <div class="step" id="step5"><div class="step-num">5</div><span>Report</span></div>
  </div>

  <div id="phase1">
    <div class="tab-bar">
      <button class="tab-btn active" id="tabSingle" onclick="setMode('single')">üè¢ Single Building</button>
      <button class="tab-btn" id="tabCampus" onclick="setMode('campus')">üèô Campus / Multi-Building</button>
    </div>
    <div id="singleMode">
      <div class="upload-zone" id="uploadZone">
        <input type="file" id="fileInput" accept=".pdf,.png,.jpg,.jpeg,.dwg,.dxf,.svg">
        <span class="upload-icon">üìê</span>
        <h3 id="upTitle">Drop your CAD drawing here</h3>
        <p id="upDesc">Floor plans, elevations, site plans ‚Äî any format accepted</p>
        <div class="upload-formats">
          <span class="fmt-badge">PDF</span><span class="fmt-badge">DWG</span><span class="fmt-badge">DXF</span>
          <span class="fmt-badge">PNG</span><span class="fmt-badge">JPG</span><span class="fmt-badge">SVG</span>
        </div>
      </div>
    </div>
    <div id="campusMode" style="display:none">
      <div class="cfg">
        <div class="slbl">Campus Project Setup</div>
        <div class="fgrid" style="margin-bottom:20px">
          <div class="ff"><label>Campus Name</label><input type="text" id="campusName" placeholder="e.g. Infosys SEZ Ahmedabad"></div>
          <div class="ff"><label>City</label><select id="campusCitySelect" onchange="onCampusChange()"></select></div>
          <div class="ff"><label>Design Month</label>
            <select id="campusMonth" onchange="onCampusChange()">
              <option value="1">January</option><option value="2">February</option><option value="3">March</option><option value="4">April</option>
              <option value="5" selected>May ‚Äî Peak Summer</option><option value="6">June</option><option value="7">July</option><option value="8">August</option>
              <option value="9">September</option><option value="10">October</option><option value="11">November</option><option value="12">December</option>
            </select>
          </div>
          <div class="ff"><label>Peak Hour (IST)</label>
            <select id="campusHour" onchange="onCampusChange()">
              <option value="8">08:00 AM</option><option value="9">09:00 AM</option><option value="10">10:00 AM</option><option value="11">11:00 AM</option>
              <option value="12">12:00 Noon</option><option value="13">01:00 PM</option><option value="14">02:00 PM</option>
              <option value="15" selected>03:00 PM</option><option value="16">04:00 PM</option><option value="17">05:00 PM</option>
            </select>
          </div>
        </div>
        <button class="add-bld" onclick="addCampusBld()">Ôºã Add Building to Campus</button>
        <div id="campusBuildings"></div>
        <div class="brow"><button class="btn btn-p" onclick="computeCampus()">‚ö° Compute Campus Heat Load ‚Üí</button></div>
      </div>
    </div>
    <div class="cfg" id="configSection" style="display:none">
      <div class="slbl">Project &amp; Location</div>
      <div class="fgrid">
        <div class="ff"><label>Project Name</label><input type="text" id="projName" placeholder="e.g. Navrangpura Office Tower"></div>
        <div class="ff"><label>City</label><select id="citySelect" onchange="onParamsChange()"></select></div>
        <div class="ff"><label>Design Month</label>
          <select id="monthSelect" onchange="onParamsChange()">
            <option value="1">January</option><option value="2">February</option><option value="3">March</option><option value="4">April</option>
            <option value="5" selected>May ‚Äî Peak Summer</option><option value="6">June</option><option value="7">July</option><option value="8">August</option>
            <option value="9">September</option><option value="10">October</option><option value="11">November</option><option value="12">December</option>
          </select>
        </div>
        <div class="ff"><label>Peak Hour (IST)</label>
          <select id="hourSelect" onchange="onParamsChange()">
            <option value="8">08:00 AM</option><option value="9">09:00 AM</option><option value="10">10:00 AM</option><option value="11">11:00 AM</option>
            <option value="12">12:00 Noon</option><option value="13">01:00 PM</option><option value="14">02:00 PM</option>
            <option value="15" selected>03:00 PM (Typical Peak)</option><option value="16">04:00 PM</option><option value="17">05:00 PM</option><option value="18">06:00 PM</option>
          </select>
        </div>
        <div class="ff"><label>Building Type</label>
          <select id="buildingType">
            <option value="office">Office Building</option><option value="retail">Retail / Mall</option>
            <option value="hotel">Hotel</option><option value="hospital">Hospital</option><option value="it">IT / Data Centre</option><option value="mixed">Mixed Use</option>
          </select>
        </div>
        <div class="ff"><label>Number of Floors</label><input type="number" id="numFloors" value="5" min="1" max="80"></div>
        <div class="ff"><label>Wall Construction</label>
          <select id="wallType">
            <option value="brick230">230mm Brick + Plaster</option><option value="brick115">115mm Brick</option>
            <option value="aac200">200mm AAC Block</option><option value="cavity">Cavity Wall + Insul.</option><option value="glass">Curtain Wall</option>
          </select>
        </div>
        <div class="ff"><label>Roof Construction</label>
          <select id="roofType">
            <option value="rcc_bare">RCC Slab (Bare)</option><option value="rcc_insulated">RCC + 50mm EPS</option>
            <option value="rcc_coolroof">RCC + Cool Roof</option><option value="rcc_full">RCC + Insul. + Cool Roof</option>
          </select>
        </div>
        <div class="ff"><label>Glazing Type</label>
          <select id="glazingType">
            <option value="single">Single (SHGC 0.86)</option><option value="double">Double (SHGC 0.55)</option>
            <option value="lowe">Low-E Double (SHGC 0.35)</option><option value="tinted">Tinted (SHGC 0.25)</option>
          </select>
        </div>
        <div class="ff"><label>Occupancy Hours/Day</label>
          <select id="occHours">
            <option value="8">8 hrs (Office)</option><option value="12">12 hrs (Extended)</option>
            <option value="18">18 hrs (Retail)</option><option value="24">24 hrs (Hospital/Hotel)</option>
          </select>
        </div>
      </div>
      <div class="ze" style="margin-top:20px">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px">
          <div style="font-family:var(--mn);font-size:11px;letter-spacing:1.5px;text-transform:uppercase;color:var(--ac)">üóÇ Zone Editor</div>
          <div style="font-size:11px;color:var(--tx2)">AI populates from drawing ‚Äî adjust as needed</div>
        </div>
        <div class="ze-hdr"><span>Zone Name</span><span>Orientation</span><span>Area m¬≤</span><span>Wall m¬≤</span><span>Glazing m¬≤</span><span>Ceil m</span><span></span></div>
        <div id="zoneRows"></div>
        <button class="add-zone" onclick="addZone()">Ôºã Add Zone</button>
      </div>
      <div class="sp" id="solPrev">
        <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px;margin-bottom:14px">
          <div style="font-family:var(--mn);font-size:11px;letter-spacing:2px;text-transform:uppercase;color:var(--ac)">‚òÄÔ∏è Live Solar ‚Äî <span id="solLbl">‚Äî</span></div>
          <div style="display:flex;align-items:center;gap:8px">
            <div id="srcBadge" style="font-family:var(--mn);font-size:9px;padding:2px 8px;border-radius:12px;border:1px solid var(--bd2);color:var(--tx3)">LOADING‚Ä¶</div>
            <select id="solSrc" onchange="onParamsChange()" style="background:var(--sf);border:1px solid var(--bd2);border-radius:5px;padding:3px 9px;color:var(--tx);font-family:var(--mn);font-size:10px;outline:none;cursor:pointer">
              <option value="auto">Auto (Best Available)</option>
              <option value="openmeteo">Open-Meteo ERA5</option>
              <option value="pvgis">PVGIS Satellite</option>
              <option value="geometry">Blanco-Muriel Model</option>
            </select>
          </div>
        </div>
        <div id="apiStat" style="display:none;font-family:var(--mn);font-size:10px;padding:6px 10px;border-radius:5px;margin-bottom:10px;border:1px solid var(--bd2);color:var(--tx2);background:var(--sf)"></div>
        <div id="srcCmp" style="display:none;background:var(--sf);border:1px solid var(--bd2);border-radius:8px;padding:12px;margin-bottom:10px;font-family:var(--mn);font-size:10px"></div>
        <div class="sg" id="solGrid"></div>
        <div class="ci" id="cityInfo"></div>
        <div style="margin-top:14px">
          <div class="pkm" id="pkMark"></div>
          <div class="bars" id="hrChart"></div>
          <div class="baxis"><span>6 AM</span><span>9 AM</span><span>12 PM</span><span>3 PM</span><span>6 PM</span></div>
        </div>
      </div>
      <div class="brow">
        <button class="btn btn-g" onclick="resetUpload()">‚Üê Change File</button>
        <button class="btn btn-p" onclick="startAnalysis()">üîç Analyse Drawing with AI ‚Üí</button>
      </div>
    </div>
  </div>

  <div id="phase2" class="hidden">
    <div id="imgPrev" class="iprev" style="display:none"><img id="prevImg" src="" alt=""><div class="pov"></div><div class="plbl" id="prevLbl">UPLOADED DRAWING</div></div>
    <div id="pdfPrev" class="iprev" style="display:none;padding:32px;text-align:center">
      <div style="font-size:40px;margin-bottom:10px">üìÑ</div>
      <div style="font-family:var(--mn);font-size:13px;color:var(--ac)" id="pdfName"></div>
      <div style="font-size:11px;color:var(--tx3);margin-top:4px" id="pdfSize"></div>
    </div>
    <div class="ap">
      <div class="slbl">AI Analysis in Progress</div>
      <div class="pi active" id="pg0"><div class="pi-ico">üîç</div><div class="pi-txt"><h4>Reading Drawing</h4><p>Parsing walls, openings and spaces...</p></div></div>
      <div class="pi" id="pg1"><div class="pi-ico">üìê</div><div class="pi-txt"><h4>Extracting Geometry</h4><p>Wall lengths, floor area, ceiling height, glazing per facade...</p></div></div>
      <div class="pi" id="pg2"><div class="pi-ico">üß≠</div><div class="pi-txt"><h4>Orientation Analysis</h4><p>Detecting North arrow, classifying N/S/E/W facades...</p></div></div>
      <div class="pi" id="pg3"><div class="pi-ico">‚òÄÔ∏è</div><div class="pi-txt"><h4>Live Solar Data</h4><p id="pg3msg">Fetching from Open-Meteo ERA5 / PVGIS satellite APIs...</p></div></div>
      <div class="pi" id="pg4"><div class="pi-ico">‚ö°</div><div class="pi-txt"><h4>Computing Heat Load</h4><p>Transmission, solar gain, internal and ventilation loads...</p></div></div>
    </div>
  </div>

  <div id="phase3" class="hidden">
    <div class="slbl">Review Extracted Data</div>
    <div class="snote" id="aiSum"></div>
    <div class="dg" id="dataGrid"></div>
    <div class="brow">
      <button class="btn btn-g" onclick="goBack()">‚Üê Back</button>
      <button class="btn btn-p" onclick="computeLoad()">‚ö° Compute Heat Load ‚Üí</button>
    </div>
  </div>

  <div id="phase4" class="hidden">
    <div id="singleRes">
      <div class="rh"><div class="rhc">
        <div class="rlbl">Total Design Heat Load</div>
        <div style="display:flex;align-items:baseline;justify-content:center;gap:12px"><div class="rval" id="totalTR">‚Äî</div><div class="runit">TR</div></div>
        <div class="rsub" id="totalKW">‚Äî kW</div>
        <div class="rmeta" id="resMeta"></div>
      </div></div>
      <div class="bkg" id="bkGrid"></div>
      <div class="slbl">Hourly Solar Profile ‚Äî <span id="resSolLbl" style="color:var(--tx2);font-family:var(--ss);font-size:11px;letter-spacing:0;text-transform:none"></span></div>
      <div class="hs"><div class="pkm" id="resPkMark"></div><div class="bars" id="resHrChart"></div><div class="baxis"><span>6 AM</span><span>9 AM</span><span>12 PM</span><span>3 PM</span><span>6 PM</span></div></div>
      <div class="slbl">Solar Irradiance by Facade</div>
      <div class="tw"><table class="dt"><thead><tr><th>Facade</th><th class="c">Sun Alt ¬∞</th><th class="c">Sun Az ¬∞</th><th class="c">Direct W/m¬≤</th><th class="c">Diffuse W/m¬≤</th><th class="c">Total W/m¬≤</th><th class="c">Level</th></tr></thead><tbody id="solTbl"></tbody></table></div>
      <div class="slbl">Zone-wise Load Distribution</div>
      <div class="tw"><table class="dt"><thead><tr><th>Zone</th><th>Area m¬≤</th><th>Trans kW</th><th>Solar kW</th><th>Internal kW</th><th>Total kW</th><th>TR</th></tr></thead><tbody id="zoneTbl"></tbody></table></div>
      <div class="slbl">Recommendations</div>
      <div class="rl" id="recList"></div>
      <div class="slbl">Standards &amp; Assumptions</div>
      <div class="snote" id="assNote"></div>
    </div>
    <div id="campusRes" style="display:none">
      <div class="rh"><div class="rhc">
        <div class="rlbl">Campus Total Heat Load</div>
        <div style="display:flex;align-items:baseline;justify-content:center;gap:12px"><div class="rval" id="campusTR">‚Äî</div><div class="runit">TR</div></div>
        <div class="rsub" id="campusKW"></div>
        <div class="rmeta" id="campusMeta"></div>
      </div></div>
      <div class="slbl">Building-wise Summary</div>
      <div class="crg" id="campusCards"></div>
      <div class="slbl">Campus Load Distribution</div>
      <div class="tw"><table class="dt"><thead><tr><th>Building</th><th>Type</th><th>Area m¬≤</th><th>Trans kW</th><th>Solar kW</th><th>Internal kW</th><th>Vent kW</th><th>Total kW</th><th>TR</th></tr></thead><tbody id="campusTbl"></tbody><tfoot id="campusFoot" style="background:var(--sf2);font-weight:700"></tfoot></table></div>
      <div class="slbl">Campus Recommendations</div>
      <div class="rl" id="campusRecs"></div>
    </div>
    <div class="dlbtns">
      <button class="dlb pdf" id="pdfBtn" onclick="generatePDF()"><span id="pdfIco">üìÑ</span> Export PDF Report</button>
      <button class="dlb" onclick="downloadTXT()">‚¨á Download TXT</button>
      <button class="btn btn-g" onclick="startOver()">‚Ü© New Calculation</button>
    </div>
  </div>
</div>
<footer><span style="font-family:var(--mn);font-size:12px;color:var(--tx3)">This solution is powered by <span style="color:var(--ac);font-weight:700">ShrviTech</span></span></footer>
<div class="toast" id="toast"></div>
<script>
const CITIES=[
  {name:"Ahmedabad",lat:23.03,lon:72.58,dbt:44,wbt:24,alt:53,zone:"Hot & Dry",state:"Gujarat"},
  {name:"Rajkot",lat:22.30,lon:70.80,dbt:43,wbt:23,alt:138,zone:"Hot & Dry",state:"Gujarat"},
  {name:"Surat",lat:21.17,lon:72.83,dbt:38,wbt:28,alt:13,zone:"Warm & Humid",state:"Gujarat"},
  {name:"Vadodara",lat:22.31,lon:73.18,dbt:43,wbt:25,alt:37,zone:"Hot & Dry",state:"Gujarat"},
  {name:"Gandhinagar",lat:23.22,lon:72.65,dbt:44,wbt:24,alt:81,zone:"Hot & Dry",state:"Gujarat"},
  {name:"Mumbai",lat:19.08,lon:72.88,dbt:35,wbt:28,alt:14,zone:"Warm & Humid",state:"Maharashtra"},
  {name:"Pune",lat:18.52,lon:73.86,dbt:38,wbt:24,alt:559,zone:"Composite",state:"Maharashtra"},
  {name:"Nagpur",lat:21.15,lon:79.09,dbt:44,wbt:25,alt:310,zone:"Hot & Dry",state:"Maharashtra"},
  {name:"Nashik",lat:20.00,lon:73.79,dbt:40,wbt:23,alt:565,zone:"Composite",state:"Maharashtra"},
  {name:"Aurangabad",lat:19.88,lon:75.34,dbt:41,wbt:23,alt:513,zone:"Composite",state:"Maharashtra"},
  {name:"Delhi",lat:28.61,lon:77.21,dbt:43,wbt:26,alt:216,zone:"Composite",state:"Delhi"},
  {name:"Jaipur",lat:26.91,lon:75.79,dbt:44,wbt:24,alt:431,zone:"Hot & Dry",state:"Rajasthan"},
  {name:"Jodhpur",lat:26.30,lon:73.03,dbt:45,wbt:22,alt:231,zone:"Hot & Dry",state:"Rajasthan"},
  {name:"Udaipur",lat:24.58,lon:73.69,dbt:41,wbt:22,alt:577,zone:"Hot & Dry",state:"Rajasthan"},
  {name:"Bikaner",lat:28.02,lon:73.32,dbt:46,wbt:22,alt:242,zone:"Hot & Dry",state:"Rajasthan"},
  {name:"Lucknow",lat:26.85,lon:80.95,dbt:43,wbt:27,alt:123,zone:"Composite",state:"Uttar Pradesh"},
  {name:"Kanpur",lat:26.46,lon:80.33,dbt:44,wbt:27,alt:142,zone:"Composite",state:"Uttar Pradesh"},
  {name:"Agra",lat:27.17,lon:78.01,dbt:44,wbt:26,alt:174,zone:"Composite",state:"Uttar Pradesh"},
  {name:"Kolkata",lat:22.57,lon:88.36,dbt:36,wbt:30,alt:6,zone:"Warm & Humid",state:"West Bengal"},
  {name:"Chennai",lat:13.08,lon:80.27,dbt:38,wbt:29,alt:16,zone:"Warm & Humid",state:"Tamil Nadu"},
  {name:"Coimbatore",lat:11.02,lon:76.97,dbt:37,wbt:25,alt:418,zone:"Warm & Humid",state:"Tamil Nadu"},
  {name:"Hyderabad",lat:17.38,lon:78.49,dbt:40,wbt:25,alt:542,zone:"Composite",state:"Telangana"},
  {name:"Bangalore",lat:12.97,lon:77.59,dbt:35,wbt:22,alt:921,zone:"Composite",state:"Karnataka"},
  {name:"Mangalore",lat:12.87,lon:74.88,dbt:34,wbt:28,alt:22,zone:"Warm & Humid",state:"Karnataka"},
  {name:"Kochi",lat:9.93,lon:76.27,dbt:34,wbt:28,alt:3,zone:"Warm & Humid",state:"Kerala"},
  {name:"Thiruvananthapuram",lat:8.52,lon:76.94,dbt:34,wbt:28,alt:64,zone:"Warm & Humid",state:"Kerala"},
  {name:"Visakhapatnam",lat:17.69,lon:83.22,dbt:37,wbt:28,alt:50,zone:"Warm & Humid",state:"Andhra Pradesh"},
  {name:"Vijayawada",lat:16.51,lon:80.62,dbt:40,wbt:28,alt:27,zone:"Warm & Humid",state:"Andhra Pradesh"},
  {name:"Bhubaneswar",lat:20.30,lon:85.82,dbt:39,wbt:27,alt:45,zone:"Warm & Humid",state:"Odisha"},
  {name:"Patna",lat:25.60,lon:85.12,dbt:41,wbt:27,alt:53,zone:"Composite",state:"Bihar"},
  {name:"Ranchi",lat:23.36,lon:85.33,dbt:38,wbt:24,alt:651,zone:"Composite",state:"Jharkhand"},
  {name:"Bhopal",lat:23.26,lon:77.41,dbt:42,wbt:25,alt:527,zone:"Composite",state:"Madhya Pradesh"},
  {name:"Indore",lat:22.72,lon:75.86,dbt:42,wbt:24,alt:553,zone:"Composite",state:"Madhya Pradesh"},
  {name:"Chandigarh",lat:30.74,lon:76.79,dbt:42,wbt:25,alt:321,zone:"Composite",state:"Punjab/Haryana"},
  {name:"Amritsar",lat:31.63,lon:74.87,dbt:42,wbt:25,alt:234,zone:"Composite",state:"Punjab"},
  {name:"Guwahati",lat:26.19,lon:91.75,dbt:37,wbt:27,alt:55,zone:"Warm & Humid",state:"Assam"},
  {name:"Dehradun",lat:30.32,lon:78.03,dbt:38,wbt:24,alt:640,zone:"Composite",state:"Uttarakhand"},
  {name:"Shimla",lat:31.10,lon:77.17,dbt:28,wbt:18,alt:2202,zone:"Cold",state:"Himachal Pradesh"},
  {name:"Srinagar",lat:34.09,lon:74.80,dbt:32,wbt:20,alt:1587,zone:"Cold",state:"J&K"},
  {name:"Raipur",lat:21.25,lon:81.63,dbt:42,wbt:27,alt:298,zone:"Composite",state:"Chhattisgarh"},
  {name:"Goa (Panaji)",lat:15.50,lon:73.83,dbt:34,wbt:28,alt:7,zone:"Warm & Humid",state:"Goa"},
];
const MN=['','January','February','March','April','May','June','July','August','September','October','November','December'];
const D2R=Math.PI/180;

// ‚îÄ‚îÄ SOLAR GEOMETRY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function solPos(lat,lon,mo,hr){
  const dom=[0,31,28,31,30,31,30,31,31,30,31,30,31];
  let doy=0;for(let i=1;i<mo;i++)doy+=dom[i];doy+=15;
  const B=(360/365)*(doy-81)*D2R,decl=23.45*Math.sin(B);
  const eot=9.87*Math.sin(2*B)-7.53*Math.cos(B)-1.5*Math.sin(B);
  const ha=15*((hr*60+eot+4*(lon-82.5))/60-12);
  const lr=lat*D2R,dr=decl*D2R,hr2=ha*D2R;
  const sinA=Math.sin(lr)*Math.sin(dr)+Math.cos(lr)*Math.cos(dr)*Math.cos(hr2);
  const alt=Math.asin(Math.max(-1,Math.min(1,sinA)))*180/Math.PI;
  let cosZ=(Math.sin(dr)-Math.sin(lr)*sinA)/(Math.cos(lr)*Math.cos(alt*D2R)+1e-9);
  let az=Math.acos(Math.max(-1,Math.min(1,cosZ)))*180/Math.PI;if(ha>0)az=360-az;
  return{alt,az};
}
function DNI(alt,mo,altM){
  if(alt<=0)return 0;
  const d=[0,31,28,31,30,31,30,31,31,30,31,30,31];let doy=0;for(let i=1;i<mo;i++)doy+=d[i];doy+=15;
  const B=(360/365)*(doy-1)*D2R,I0=1367*(1+0.033*Math.cos(B));
  const sA=Math.sin(alt*D2R),h=altM/1000;
  const a0=0.4237-0.00821*Math.pow(6-h,2),a1=0.5055+0.00595*Math.pow(6.5-h,2),k=0.2711+0.01858*Math.pow(2.5-h,2);
  return I0*(a0+a1*Math.exp(-k/sA));
}
function diffH(alt,mo,altM){
  if(alt<=0)return 0;
  const d=[0,31,28,31,30,31,30,31,31,30,31,30,31];let doy=0;for(let i=1;i<mo;i++)doy+=d[i];doy+=15;
  const B=(360/365)*(doy-1)*D2R;return 1367*(1+0.033*Math.cos(B))*Math.sin(alt*D2R)*0.26;
}
function geoF(sA,sZ,fZ,mo,am){const cosT=Math.cos(sA*D2R)*Math.cos((sZ-fZ)*D2R);const d=Math.round(sA>0&&cosT>0?DNI(sA,mo,am)*cosT:0);const f=Math.round(sA>0?diffH(sA,mo,am)*0.5:0);return{direct:d,diffuse:f,total:d+f};}
function geoR(sA,mo,am){const d=Math.round(sA>0?DNI(sA,mo,am)*Math.sin(sA*D2R):0);const f=Math.round(sA>0?diffH(sA,mo,am):0);return{direct:d,diffuse:f,total:d+f};}
function geoAll(lat,lon,mo,hr,am){const s=solPos(lat,lon,mo,hr);return{sol:s,facades:{North:geoF(s.alt,s.az,0,mo,am),East:geoF(s.alt,s.az,90,mo,am),South:geoF(s.alt,s.az,180,mo,am),West:geoF(s.alt,s.az,270,mo,am),Roof:geoR(s.alt,mo,am)}};}
function geoHr(lat,lon,mo,am){const o=[];for(let h=6;h<=18;h++){const s=solPos(lat,lon,mo,h);o.push({h,ghi:geoR(s.alt,mo,am).total});}return o;}

// ‚îÄ‚îÄ MULTI-SOURCE SOLAR API ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const SC={};let lastSol=null;
async function fetchOM(lat,lon,mo){
  const k=`om_${lat}_${lon}_${mo}`;if(SC[k])return SC[k];
  const dom=[0,31,28,31,30,31,30,31,31,30,31,30,31],m=String(mo).padStart(2,'0'),ed=String(dom[mo]).padStart(2,'0');
  const r=await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&hourly=shortwave_radiation,direct_normal_irradiance,diffuse_radiation,direct_radiation&start_date=2023-${m}-01&end_date=2023-${m}-${ed}&timezone=Asia%2FKolkata`,{signal:AbortSignal.timeout(8000)});
  if(!r.ok)throw new Error(`OM ${r.status}`);
  const data=await r.json(),hr=data.hourly,nD=dom[mo],by={};
  for(let d=0;d<nD;d++)for(let h=0;h<24;h++){const i=d*24+h;if(!by[h])by[h]={ghi:[],dni:[],dhi:[],dir:[]};by[h].ghi.push(hr.shortwave_radiation[i]||0);by[h].dni.push(hr.direct_normal_irradiance[i]||0);by[h].dhi.push(hr.diffuse_radiation[i]||0);by[h].dir.push(hr.direct_radiation[i]||0);}
  const avg=a=>a.reduce((x,y)=>x+y,0)/a.length,res={};
  for(let h=0;h<24;h++){const b=by[h]||{ghi:[0],dni:[0],dhi:[0],dir:[0]};res[h]={ghi:Math.round(avg(b.ghi)),dni:Math.round(avg(b.dni)),dhi:Math.round(avg(b.dhi)),dir:Math.round(avg(b.dir))};}
  SC[k]=res;return res;
}
async function fetchPV(lat,lon,mo){
  const k=`pv_${lat}_${lon}_${mo}`;if(SC[k])return SC[k];
  const r=await fetch(`https://re.jrc.ec.europa.eu/api/v5_2/tmy?lat=${lat}&lon=${lon}&usehorizon=1&outputformat=json&browser=1`,{signal:AbortSignal.timeout(10000)});
  if(!r.ok)throw new Error(`PVGIS ${r.status}`);
  const data=await r.json(),rows=data.outputs?.tmy_hourly||[],by={};
  rows.forEach(row=>{const t=row['time(UTC)']||'';if(parseInt(t.substring(4,6))!==mo)return;const h=parseInt(t.substring(9,11));if(!by[h])by[h]={ghi:[],dni:[],dhi:[]};by[h].ghi.push(row['G(h)']||0);by[h].dni.push(row['Gb(n)']||0);by[h].dhi.push(row['Gd(h)']||0);});
  if(!Object.keys(by).length)throw new Error('PVGIS no data');
  const avg=a=>a.reduce((x,y)=>x+y,0)/a.length,res={};
  for(let h=0;h<24;h++){const b=by[h]||{ghi:[0],dni:[0],dhi:[0]};res[h]={ghi:Math.round(avg(b.ghi)),dni:Math.round(avg(b.dni)),dhi:Math.round(avg(b.dhi)),dir:Math.round(avg(b.ghi)*0.7)};}
  SC[k]=res;return res;
}
function apiFac(ad,sol,mo,am){
  const h=ad[sol.hourInt]||{ghi:0,dni:0,dhi:0,dir:0};if(!h.ghi)return geoAll(0,0,mo,sol.hourInt,am).facades;
  const vF=fZ=>{const cosT=Math.cos(sol.alt*D2R)*Math.cos((sol.az-fZ)*D2R);return{direct:cosT>0?Math.round(h.dni*cosT):0,diffuse:Math.round((h.dhi||h.ghi*0.3)*0.5),total:0};};
  const facs={North:vF(0),East:vF(90),South:vF(180),West:vF(270),Roof:{direct:Math.round(h.dir||h.ghi*0.7),diffuse:Math.round(h.dhi||h.ghi*0.3),total:h.ghi}};
  ['North','East','South','West'].forEach(k=>{facs[k].total=facs[k].direct+facs[k].diffuse;});
  return facs;
}
function srcConf(s){return{pvgis:{score:96,label:'Very High',color:'#22c55e',note:'PVGIS-SARAH3 ¬±5%'},openmeteo:{score:89,label:'High',color:'#3b82f6',note:'ERA5 reanalysis ¬±10%'},geometry:{score:72,label:'Good',color:'#eab308',note:'Blanco-Muriel ¬±15%'}}[s]||{score:72,label:'Good',color:'#eab308',note:''};}

async function fetchSolar(city,mo,hr){
  const pref=document.getElementById('solSrc')?.value||'auto';
  const sol=solPos(city.lat,city.lon,mo,hr);sol.hourInt=hr;
  const setStat=(msg,c='var(--tx2)')=>{const b=document.getElementById('apiStat');if(b){b.style.display='block';b.style.color=c;b.innerHTML=msg;}};
  let omD=null,pvD=null,chosen='geometry';
  if(pref==='auto'||pref==='openmeteo'){try{setStat('‚è≥ Fetching Open-Meteo ERA5‚Ä¶');omD=await fetchOM(city.lat,city.lon,mo);chosen='openmeteo';setStat('‚úÖ <strong>Open-Meteo ERA5</strong> loaded','#3b82f6');}catch(e){setStat(`‚ö†Ô∏è Open-Meteo ‚Äî ${e.message}`,'#eab308');}}
  if((pref==='auto'&&!omD)||pref==='pvgis'){try{setStat('‚è≥ Fetching PVGIS-SARAH3‚Ä¶');pvD=await fetchPV(city.lat,city.lon,mo);chosen='pvgis';setStat('‚úÖ <strong>PVGIS-SARAH3</strong> loaded','#22c55e');}catch(e){setStat(`‚ö†Ô∏è PVGIS ‚Äî ${e.message}`,'#eab308');}}
  if(pref==='geometry'){chosen='geometry';const b=document.getElementById('apiStat');if(b)b.style.display='none';}
  const geo=geoAll(city.lat,city.lon,mo,hr,city.alt);
  let facades,hourly;
  if(chosen==='openmeteo'&&omD){facades=apiFac(omD,sol,mo,city.alt);hourly=Object.entries(omD).filter(([h])=>+h>=6&&+h<=18).map(([h,d])=>({h:+h,ghi:d.ghi})).sort((a,b)=>a.h-b.h);}
  else if(chosen==='pvgis'&&pvD){facades=apiFac(pvD,sol,mo,city.alt);hourly=Object.entries(pvD).filter(([h])=>+h>=6&&+h<=18).map(([h,d])=>({h:+h,ghi:d.ghi})).sort((a,b)=>a.h-b.h);}
  else{chosen='geometry';facades=geo.facades;hourly=geoHr(city.lat,city.lon,mo,city.alt);if(pref!=='geometry')setStat('‚ÑπÔ∏è Using <strong>Blanco-Muriel</strong> ‚Äî APIs unavailable','var(--tx2)');}
  // Comparison panel
  const ce=document.getElementById('srcCmp');
  if(ce&&omD){const og=omD[hr]?.ghi||0,gg=geoR(geo.sol.alt,mo,city.alt).total;const pct=gg>0?(Math.abs(og-gg)/gg*100).toFixed(0):'‚Äî';ce.style.display='block';ce.innerHTML=`<div style="color:var(--ac);letter-spacing:1px;margin-bottom:8px">SOURCE COMPARISON ¬∑ GHI @ ${hr}:00 IST</div><div style="display:grid;grid-template-columns:repeat(3,1fr);gap:6px;text-align:center"><div><div style="color:var(--tx3);font-size:9px;margin-bottom:2px">OPEN-METEO</div><div style="color:#3b82f6;font-size:15px">${og} W/m¬≤</div></div><div><div style="color:var(--tx3);font-size:9px;margin-bottom:2px">GEOMETRY</div><div style="color:#eab308;font-size:15px">${gg} W/m¬≤</div></div><div><div style="color:var(--tx3);font-size:9px;margin-bottom:2px">VARIANCE</div><div style="color:${Math.abs(og-gg)<100?'#22c55e':'#f97316'};font-size:15px">${pct}%</div></div></div>`;} else if(ce)ce.style.display='none';
  const sn={openmeteo:'OPEN-METEO ERA5',pvgis:'PVGIS-SARAH3',geometry:'BLANCO-MURIEL'},sc={openmeteo:'#3b82f6',pvgis:'#22c55e',geometry:'#eab308'};
  const badge=document.getElementById('srcBadge');if(badge){badge.textContent=sn[chosen];badge.style.color=sc[chosen];badge.style.borderColor=sc[chosen];}
  return{sol,facades,hourly,source:chosen,conf:srcConf(chosen)};
}

// ‚îÄ‚îÄ RENDER HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderSolGrid(id,F,src){
  const lbl={openmeteo:'ERA5',pvgis:'PVGIS',geometry:'Model'}[src]||'';
  const items=[{d:'N',k:'North',c:'#3b82f6'},{d:'E',k:'East',c:'#22c55e'},{d:'S',k:'South',c:'#eab308'},{d:'W',k:'West',c:'#f97316'},{d:'ROOF',k:'Roof',c:'#ef4444'}];
  const mx=Math.max(...items.map(f=>F[f.k].total),1);
  document.getElementById(id).innerHTML=items.map(f=>`<div class="sc"><div class="sc-dir">${f.d}</div><div class="sc-val" style="color:${f.c}">${F[f.k].total}</div><div class="sc-unit">W/m¬≤ <span style="font-size:8px;opacity:.5">${lbl}</span></div><div class="sc-bar"><div class="sc-fill" style="width:${(F[f.k].total/mx*100).toFixed(0)}%;background:${f.c}"></div></div></div>`).join('');
}
function renderCI(id,city,sol,conf){
  const ch=conf?`<span>üéØ <strong style="color:${conf.color}">${conf.label} (${conf.score}%)</strong></span>`:'';
  document.getElementById(id).innerHTML=`<span>üìç <strong>${city.name}</strong></span><span>üå° <strong>${city.dbt}¬∞C DBT</strong>/<strong>${city.wbt}¬∞C WBT</strong></span><span>üåç <strong>${city.lat}¬∞N</strong></span><span>üå§ <strong>${city.zone}</strong></span><span>‚òÄÔ∏è Alt <strong>${sol.alt.toFixed(1)}¬∞</strong></span><span>üß≠ Az <strong>${sol.az.toFixed(1)}¬∞</strong></span>${ch}`;
}
function renderBars(cId,mId,arr,sel,src){
  if(!arr||!arr.length)return;
  const mx=Math.max(...arr.map(h=>h.ghi),1),pk=arr.reduce((a,b)=>b.ghi>a.ghi?b:a,arr[0]);
  const sl={openmeteo:'Open-Meteo ERA5',pvgis:'PVGIS-SARAH3',geometry:'Blanco-Muriel'}[src]||'';
  const m=document.getElementById(mId);if(m)m.textContent=`Peak: ${pk.ghi} W/m¬≤ @ ${pk.h}:00 ¬∑ Design: ${sel}:00 IST ¬∑ ${sl}`;
  document.getElementById(cId).innerHTML=arr.map(h=>{const pct=(h.ghi/mx*100).toFixed(0),isSel=h.h===sel;let c=h.ghi>600?'#ef4444':h.ghi>400?'#f97316':h.ghi>200?'#eab308':'#22c55e';if(isSel)c='#fff';return`<div class="bw"><div class="bar" style="height:${Math.max(pct,2)}%;background:${c};opacity:${isSel?1:.55};outline:${isSel?'2px solid var(--ac)':'none'};outline-offset:2px" data-tip="${h.h}:00 ‚Äî ${h.ghi}W/m¬≤"></div><div class="blbl">${h.h%3===0?h.h:''}</div></div>`;}).join('');
}

// ‚îÄ‚îÄ ZONE EDITOR ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let zc=0;
function addZone(d){
  zc++;const id=`z${zc}`;
  const el=document.createElement('div');el.className='zrow';el.id=`zr_${id}`;
  const orOpts=['North','South','East','West','Core'].map(o=>`<option value="${o}" ${(d?.orientation||'North')===o?'selected':''}>${o}</option>`).join('');
  el.innerHTML=`<div class="ff"><input type="text" placeholder="Zone name" value="${d?.name||''}"></div><div class="ff"><select>${orOpts}</select></div><div class="ff"><input type="number" placeholder="800" value="${d?.area_m2||''}" min="0"></div><div class="ff"><input type="number" placeholder="200" value="${d?.wall_area_m2||''}" min="0"></div><div class="ff"><input type="number" placeholder="40" value="${d?.glazing_area_m2||''}" min="0"></div><div class="ff"><input type="number" placeholder="2.85" value="${d?.ceiling_height_m||2.85}" step="0.05" min="2"></div><button class="zdel" onclick="document.getElementById('zr_${id}').remove()">‚úï</button>`;
  document.getElementById('zoneRows').appendChild(el);
}
function getZones(){
  const rows=document.getElementById('zoneRows').querySelectorAll('.zrow'),zones=[];
  rows.forEach(r=>{const inp=r.querySelectorAll('input,select');const a=parseFloat(inp[2].value)||0;if(a>0)zones.push({name:inp[0].value||'Zone',orientation:inp[1].value,area_m2:a,wall_area_m2:parseFloat(inp[3].value)||0,glazing_area_m2:parseFloat(inp[4].value)||0,ceiling_height_m:parseFloat(inp[5].value)||2.85});});
  return zones;
}
function popZones(zones){document.getElementById('zoneRows').innerHTML='';zc=0;zones.forEach(z=>addZone(z));}
function defZones(fp,fl,wgp,sgp){
  const h=3.6,L=Math.sqrt(fp)*1.4,W=fp/L;
  return[{name:'North Perimeter',orientation:'North',area_m2:fp*fl*0.18,wall_area_m2:L*h*fl,glazing_area_m2:L*h*fl*0.15,ceiling_height_m:2.85},{name:'South Perimeter',orientation:'South',area_m2:fp*fl*0.18,wall_area_m2:L*h*fl,glazing_area_m2:L*h*fl*(sgp/100||0.2),ceiling_height_m:2.85},{name:'East Perimeter',orientation:'East',area_m2:fp*fl*0.14,wall_area_m2:W*h*fl,glazing_area_m2:W*h*fl*0.18,ceiling_height_m:2.85},{name:'West Perimeter',orientation:'West',area_m2:fp*fl*0.14,wall_area_m2:W*h*fl,glazing_area_m2:W*h*fl*(wgp/100||0.25),ceiling_height_m:2.85},{name:'Core / Interior',orientation:'Core',area_m2:fp*fl*0.36,wall_area_m2:0,glazing_area_m2:0,ceiling_height_m:2.85}];
}

// ‚îÄ‚îÄ CAMPUS BUILDER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let cbc=0;
function addCampusBld(){
  cbc++;const id=`b${cbc}`;
  const el=document.createElement('div');el.className='cbc';el.id=`bc_${id}`;
  el.innerHTML=`<div class="cbh" onclick="toggleB('${id}')"><div class="cbt"><span class="cbbdg">BLD ${cbc}</span><span id="bt_${id}">Building ${cbc}</span></div><div style="display:flex;gap:8px"><button class="btn btn-g" style="padding:5px 10px;font-size:10px" onclick="event.stopPropagation();document.getElementById('bc_${id}').remove()">Remove</button><span style="font-family:var(--mn);font-size:11px;color:var(--tx3)">‚ñº</span></div></div><div class="cbb open" id="bb_${id}"><div class="fgrid" style="margin-top:14px"><div class="ff"><label>Building Name</label><input type="text" id="bn_${id}" value="Building ${cbc}" oninput="document.getElementById('bt_${id}').textContent=this.value"></div><div class="ff"><label>Type</label><select id="btype_${id}"><option value="office">Office</option><option value="retail">Retail/Mall</option><option value="hotel">Hotel</option><option value="hospital">Hospital</option><option value="it">IT/Data Centre</option><option value="mixed">Mixed Use</option></select></div><div class="ff"><label>Floors</label><input type="number" id="bfl_${id}" value="4" min="1" max="80"></div><div class="ff"><label>Floor Plate m¬≤</label><input type="number" id="bfp_${id}" value="800" min="100"></div><div class="ff"><label>Wall</label><select id="bw_${id}"><option value="brick230">230mm Brick</option><option value="aac200">200mm AAC</option><option value="cavity">Cavity+Insul</option><option value="glass">Curtain Wall</option></select></div><div class="ff"><label>Roof</label><select id="br_${id}"><option value="rcc_bare">RCC Bare</option><option value="rcc_insulated" selected>RCC+EPS</option><option value="rcc_coolroof">Cool Roof</option><option value="rcc_full">Insul+Cool</option></select></div><div class="ff"><label>Glazing</label><select id="bg_${id}"><option value="single">Single</option><option value="double" selected>Double</option><option value="lowe">Low-E</option><option value="tinted">Tinted</option></select></div><div class="ff"><label>West Glazing %</label><input type="number" id="bwg_${id}" value="25" min="0" max="100"></div><div class="ff"><label>South Glazing %</label><input type="number" id="bsg_${id}" value="20" min="0" max="100"></div></div></div>`;
  document.getElementById('campusBuildings').appendChild(el);
}
function toggleB(id){document.getElementById(`bb_${id}`).classList.toggle('open');}
function getCampusBlds(){
  return Array.from(document.getElementById('campusBuildings').querySelectorAll('.cbc')).map(c=>{
    const id=c.id.replace('bc_','');
    const fp=parseFloat(document.getElementById(`bfp_${id}`)?.value)||800,fl=parseInt(document.getElementById(`bfl_${id}`)?.value)||4;
    return{id,name:document.getElementById(`bn_${id}`)?.value||'Building',type:document.getElementById(`btype_${id}`)?.value||'office',floors:fl,fp,totalArea:fp*fl,wallType:document.getElementById(`bw_${id}`)?.value||'brick230',roofType:document.getElementById(`br_${id}`)?.value||'rcc_bare',glazingType:document.getElementById(`bg_${id}`)?.value||'double',wgp:parseFloat(document.getElementById(`bwg_${id}`)?.value)||25,sgp:parseFloat(document.getElementById(`bsg_${id}`)?.value)||20};
  });
}

// ‚îÄ‚îÄ HEAT LOAD ENGINE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const wU={brick230:2.1,brick115:3.2,aac200:1.1,cavity:0.6,glass:5.8};
const rU={rcc_bare:3.8,rcc_insulated:0.65,rcc_coolroof:2.8,rcc_full:0.45};
const gU={single:5.8,double:2.8,lowe:1.8,tinted:2.4};
const shgcM={single:0.86,double:0.55,lowe:0.35,tinted:0.25};
const occD={office:10,retail:5,hotel:20,hospital:15,it:15,mixed:10};
const litW={office:12,retail:20,hotel:10,hospital:15,it:20,mixed:14};
const eqW={office:20,retail:25,hotel:15,hospital:20,it:80,mixed:22};

function calcZones(zones,F,env,int_,city,o){
  const dT=city.dbt-24,wAbs=env.wall_absorptivity||0.5,ho=20;
  const sad={North:(wAbs*F.North.total)/ho,South:(wAbs*F.South.total)/ho,East:(wAbs*F.East.total)/ho,West:(wAbs*F.West.total)/ho,Core:0};
  let tT=0,tS=0,tI=0;const zr=[];
  zones.forEach(z=>{
    const idir=F[z.orientation]?.total||0,ow=Math.max((z.wall_area_m2||0)-(z.glazing_area_m2||0),0);
    const qW=(env.wall_u_value||2.1)*ow*(dT+(sad[z.orientation]||0))/1000;
    const qG=(env.glazing_u_value||2.8)*(z.glazing_area_m2||0)*dT/1000;
    const sf=(z.orientation==='South'&&o?.has_shading_south)?0.6:(z.orientation==='West'&&o?.has_shading_west)?0.6:1.0;
    const qSol=(env.glazing_shgc||0.55)*(z.glazing_area_m2||0)*idir*sf/1000;
    const ppl=(z.area_m2||0)/(int_.occupancy_density_m2_per_person||10);
    const qI=ppl*130/1000+(int_.lighting_w_per_m2||12)*(z.area_m2||0)/1000+(int_.equipment_w_per_m2||20)*(z.area_m2||0)/1000;
    const tot=qW+qG+qSol+qI;
    zr.push({name:z.name,orientation:z.orientation,area:z.area_m2||0,trans:qW+qG,solar:qSol,internal:qI,total:tot,tr:tot/3.517});
    tT+=qW+qG;tS+=qSol;tI+=qI;
  });
  const fp=zones.reduce((a,z)=>a+(z.area_m2||0),0)/Math.max(env.num_floors||1,1);
  tT+=(env.roof_u_value||3.8)*fp*(dT+(wAbs*F.Roof.total)/ho)/1000;
  return{zones:zr,tT,tS,tI};
}
function calcVent(fa,city,int_){
  const dT=city.dbt-24,ppl=fa/(int_.occupancy_density_m2_per_person||10),m3s=ppl*(int_.fresh_air_cfm_per_person||10)*0.000472;
  return 1.2*m3s*dT+3010*m3s*0.010;
}

// ‚îÄ‚îÄ APP STATE & MODE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let upFile=null,upType=null,exData={},compR={},campR=null,appMode='single';
function setMode(m){appMode=m;document.getElementById('tabSingle').classList.toggle('active',m==='single');document.getElementById('tabCampus').classList.toggle('active',m==='campus');document.getElementById('singleMode').style.display=m==='single'?'block':'none';document.getElementById('campusMode').style.display=m==='campus'?'block':'none';document.getElementById('configSection').style.display='none';}
function setStep(n){for(let i=1;i<=5;i++){const e=document.getElementById(`step${i}`);e.className='step';if(i<n)e.classList.add('done');else if(i===n)e.classList.add('active');}}
function showPhase(n){[1,2,3,4].forEach(i=>{const e=document.getElementById(`phase${i}`);i===n?(e.classList.remove('hidden'),e.classList.add('fade-in')):e.classList.add('hidden');});setStep([0,1,2,3,4,5][n]);window.scrollTo({top:0,behavior:'smooth'});}
function getCity(id){return CITIES.find(c=>c.name===document.getElementById(id).value)||CITIES[0];}
function showToast(msg){const t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),3000);}

function populateCities(){
  ['citySelect','campusCitySelect'].forEach(sid=>{
    const sel=document.getElementById(sid);if(!sel)return;
    const gs={};CITIES.forEach(c=>{if(!gs[c.state])gs[c.state]=[];gs[c.state].push(c);});
    Object.keys(gs).sort().forEach(st=>{const og=document.createElement('optgroup');og.label=st;gs[st].forEach(c=>{const o=document.createElement('option');o.value=c.name;o.textContent=c.name;if(c.name==='Ahmedabad')o.selected=true;og.appendChild(o);});sel.appendChild(og);});
  });
}

// ‚îÄ‚îÄ UPLOAD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const UZ=document.getElementById('uploadZone'),FI=document.getElementById('fileInput');
UZ.addEventListener('click',()=>FI.click());
UZ.addEventListener('dragover',e=>{e.preventDefault();UZ.classList.add('dragover')});
UZ.addEventListener('dragleave',()=>UZ.classList.remove('dragover'));
UZ.addEventListener('drop',e=>{e.preventDefault();UZ.classList.remove('dragover');if(e.dataTransfer.files[0])handleFile(e.dataTransfer.files[0])});
FI.addEventListener('change',e=>{if(e.target.files[0])handleFile(e.target.files[0])});
function handleFile(f){
  upFile=f;upType=f.name.split('.').pop().toLowerCase();
  document.getElementById('upTitle').textContent=f.name;document.getElementById('upDesc').textContent=`${(f.size/1024).toFixed(0)} KB ¬∑ Ready`;
  UZ.style.borderColor='var(--ac)';
  const cfg=document.getElementById('configSection');cfg.style.display='block';cfg.classList.add('fade-in');
  if(!document.getElementById('zoneRows').children.length)['North','South','East','West','Core'].forEach(o=>addZone({name:`${o} Zone`,orientation:o}));
  onParamsChange();
}
function resetUpload(){upFile=null;document.getElementById('upTitle').textContent='Drop your CAD drawing here';document.getElementById('upDesc').textContent='Floor plans, elevations, site plans ‚Äî any format accepted';UZ.style.borderColor='';document.getElementById('configSection').style.display='none';FI.value='';}
function goBack(){showPhase(1);document.getElementById('configSection').style.display='block';}
function startOver(){upFile=null;exData={};compR={};campR=null;resetUpload();showPhase(1);document.getElementById('configSection').style.display='none';document.getElementById('singleRes').style.display='block';document.getElementById('campusRes').style.display='none';}

async function onParamsChange(){
  const city=getCity('citySelect'),mo=parseInt(document.getElementById('monthSelect').value),hr=parseInt(document.getElementById('hourSelect').value);
  document.getElementById('solLbl').textContent=`${city.name} ¬∑ ${MN[mo]} ¬∑ ${hr}:00 IST`;
  document.getElementById('solPrev').classList.add('vis');
  const geo=geoAll(city.lat,city.lon,mo,hr,city.alt);
  renderSolGrid('solGrid',geo.facades,'geometry');renderCI('cityInfo',city,geo.sol,null);renderBars('hrChart','pkMark',geoHr(city.lat,city.lon,mo,city.alt),hr,'geometry');
  try{const r=await fetchSolar(city,mo,hr);lastSol=r;renderSolGrid('solGrid',r.facades,r.source);renderCI('cityInfo',city,r.sol,r.conf);renderBars('hrChart','pkMark',r.hourly,hr,r.source);}catch(e){console.error(e);}
}
async function onCampusChange(){
  const city=getCity('campusCitySelect'),mo=parseInt(document.getElementById('campusMonth').value),hr=parseInt(document.getElementById('campusHour').value);
  try{await fetchSolar(city,mo,hr);}catch(e){}
}

// ‚îÄ‚îÄ AI ANALYSIS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function startAnalysis(){
  if(!upFile){showToast('Upload a drawing first');return;}
  showPhase(2);
  if(['png','jpg','jpeg','svg','gif'].includes(upType)){const rd=new FileReader();rd.onload=e=>{document.getElementById('prevImg').src=e.target.result;document.getElementById('prevLbl').textContent=upFile.name.toUpperCase();document.getElementById('imgPrev').style.display='block';};rd.readAsDataURL(upFile);}
  else{document.getElementById('pdfName').textContent=upFile.name;document.getElementById('pdfSize').textContent=`${(upFile.size/1024).toFixed(0)} KB ¬∑ ${upType.toUpperCase()}`;document.getElementById('pdfPrev').style.display='block';}
  [0,1200,2500,3700,4900].forEach((d,i)=>setTimeout(()=>{
    if(i>0){const p=document.getElementById(`pg${i-1}`);p.classList.remove('active');p.classList.add('done');p.querySelector('.pi-ico').textContent='‚úÖ';}
    document.getElementById(`pg${i}`).classList.add('active');
    if(i===3&&lastSol)document.getElementById('pg3msg').textContent=`Solar: ${({openmeteo:'Open-Meteo ERA5',pvgis:'PVGIS-SARAH3',geometry:'Blanco-Muriel'})[lastSol.source]} ¬∑ Confidence ${lastSol.conf?.score}%`;
  },d));
  await new Promise(r=>setTimeout(r,5300));
  await callAI();
}

function f2b64(f){return new Promise((r,x)=>{const rd=new FileReader();rd.onload=e=>r(e.target.result.split(',')[1]);rd.onerror=()=>x(new Error('fail'));rd.readAsDataURL(f);});}

async function callAI(){
  const city=getCity('citySelect'),mo=parseInt(document.getElementById('monthSelect').value),hr=parseInt(document.getElementById('hourSelect').value);
  let sr=lastSol;if(!sr){const g=geoAll(city.lat,city.lon,mo,hr,city.alt);sr={sol:g.sol,facades:g.facades,hourly:geoHr(city.lat,city.lon,mo,city.alt),source:'geometry',conf:srcConf('geometry')};}
  const{sol,facades}=sr,bt=document.getElementById('buildingType').value,nf=document.getElementById('numFloors').value,wt=document.getElementById('wallType').value,rt=document.getElementById('roofType').value,gt=document.getElementById('glazingType').value,pn=document.getElementById('projName').value||'Commercial Building';
  const srcName={openmeteo:'Open-Meteo ERA5',pvgis:'PVGIS-SARAH3',geometry:'Blanco-Muriel'}[sr.source]||sr.source;
  const SYS=`You are an expert MEP engineer (ISHRAE/NBC Part 8). Analyze the architectural drawing. Respond ONLY with valid JSON, no markdown:
{"summary":"2-3 sentences","geometry":{"total_floor_area_m2":number,"floor_plate_area_m2":number,"num_floors":number,"floor_to_floor_height_m":number,"floor_to_ceiling_height_m":number,"gross_perimeter_m":number,"building_footprint_length_m":number,"building_footprint_width_m":number},"orientation":{"north_wall_length_m":number,"south_wall_length_m":number,"east_wall_length_m":number,"west_wall_length_m":number,"has_shading_south":boolean,"has_shading_west":boolean},"envelope":{"wall_u_value":number,"roof_u_value":number,"glazing_u_value":number,"glazing_shgc":number,"north_glazing_pct":number,"south_glazing_pct":number,"east_glazing_pct":number,"west_glazing_pct":number,"roof_absorptivity":number,"wall_absorptivity":number},"internal":{"occupancy_density_m2_per_person":number,"lighting_w_per_m2":number,"equipment_w_per_m2":number,"fresh_air_cfm_per_person":number},"zones":[{"name":"string","orientation":"North|South|East|West|Core","area_m2":number,"wall_area_m2":number,"glazing_area_m2":number,"ceiling_height_m":number}]}`;
  const USR=`Project:${pn}\nCity:${city.name}(${city.lat}¬∞N,${city.lon}¬∞E,${city.alt}m) ${city.zone} DBT${city.dbt}¬∞C WBT${city.wbt}¬∞C\nDesign:${MN[mo]} ${hr}:00 IST\nSolar(${srcName}):Alt${sol.alt.toFixed(1)}¬∞ Az${sol.az.toFixed(1)}¬∞ N=${facades.North.total} E=${facades.East.total} S=${facades.South.total} W=${facades.West.total} Roof=${facades.Roof.total}W/m¬≤\nType:${bt} Floors:${nf} Wall:${wt} Roof:${rt} Glazing:${gt}`;
  try{
    let msgs;const ie=['png','jpg','jpeg','gif','webp'];
    if(ie.includes(upType)){const b64=await f2b64(upFile);msgs=[{role:'user',content:[{type:'image',source:{type:'base64',media_type:upType==='jpg'?'image/jpeg':`image/${upType}`,data:b64}},{type:'text',text:USR}]}];}
    else if(upType==='pdf'){const b64=await f2b64(upFile);msgs=[{role:'user',content:[{type:'document',source:{type:'base64',media_type:'application/pdf',data:b64}},{type:'text',text:USR}]}];}
    else msgs=[{role:'user',content:USR+`\n\n[${upType.toUpperCase()} file ‚Äî generate realistic data from parameters. State assumptions in summary.]`}];
    const res=await fetch('https://api.anthropic.com/v1/messages',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({model:'claude-sonnet-4-20250514',max_tokens:3000,system:SYS,messages:msgs})});
    const data=await res.json();if(data.error)throw new Error(data.error.message);
    let raw=data.content.map(c=>c.text||'').join('').replace(/```json|```/g,'').trim();
    const s=raw.indexOf('{'),e=raw.lastIndexOf('}');if(s!==-1&&e!==-1)raw=raw.slice(s,e+1);
    exData=JSON.parse(raw);if(exData.zones?.length)popZones(exData.zones);
  }catch(err){console.error(err);exData=fallback(city,mo,hr,sr);}
  showExtracted(city,mo,hr,sr);
}
function fallback(city,mo,hr,sr){
  const nf=parseInt(document.getElementById('numFloors').value)||5,bt=document.getElementById('buildingType').value,fp=800;
  return{summary:`Parameters-based estimate for ${city.name} (${city.zone}). Assumed ${bt} building, ${nf}F √ó ${fp}m¬≤. Solar: ${({openmeteo:'Open-Meteo ERA5',pvgis:'PVGIS-SARAH3',geometry:'Blanco-Muriel'})[sr.source]}.`,geometry:{total_floor_area_m2:fp*nf,floor_plate_area_m2:fp,num_floors:nf,floor_to_floor_height_m:3.6,floor_to_ceiling_height_m:2.85,gross_perimeter_m:120,building_footprint_length_m:40,building_footprint_width_m:20},orientation:{north_wall_length_m:40,south_wall_length_m:40,east_wall_length_m:20,west_wall_length_m:20,has_shading_south:true,has_shading_west:false},envelope:{wall_u_value:wU[document.getElementById('wallType').value]||2.1,roof_u_value:rU[document.getElementById('roofType').value]||3.8,glazing_u_value:gU[document.getElementById('glazingType').value]||2.8,glazing_shgc:shgcM[document.getElementById('glazingType').value]||0.55,north_glazing_pct:15,south_glazing_pct:25,east_glazing_pct:20,west_glazing_pct:30,roof_absorptivity:0.9,wall_absorptivity:0.5},internal:{occupancy_density_m2_per_person:occD[bt]||10,lighting_w_per_m2:litW[bt]||12,equipment_w_per_m2:eqW[bt]||20,fresh_air_cfm_per_person:10},zones:defZones(fp,nf,30,25)};
}

function showExtracted(city,mo,hr,sr){
  const p=document.getElementById('pg4');p.classList.remove('active');p.classList.add('done');p.querySelector('.pi-ico').textContent='‚úÖ';
  setTimeout(()=>{
    showPhase(3);
    const{sol,facades,source:src,conf}=sr,srcFull={openmeteo:'Open-Meteo ERA5',pvgis:'PVGIS-SARAH3',geometry:'Blanco-Muriel+Hottel'}[src]||src;
    document.getElementById('aiSum').innerHTML=`<strong>üìã AI Summary</strong><br><br>${exData.summary||'Analysis complete.'}<br><br>‚òÄÔ∏è Solar: <strong>${srcFull}</strong> ¬∑ Confidence <strong style="color:${conf?.color}">${conf?.label} (${conf?.score}%)</strong> ¬∑ ${conf?.note}`;
    const g=exData.geometry||{},o=exData.orientation||{},env=exData.envelope||{},int_=exData.internal||{};
    const cards=[
      {label:'Geometry',rows:[['Total Area',`${(g.total_floor_area_m2||0).toFixed(0)} m¬≤`],['Floor Plate',`${(g.floor_plate_area_m2||0).toFixed(0)} m¬≤`],['Floors',g.num_floors],['Ceiling',`${g.floor_to_ceiling_height_m} m`],['Perimeter',`${g.gross_perimeter_m} m`],['Footprint',`${g.building_footprint_length_m}√ó${g.building_footprint_width_m} m`]]},
      {label:'Orientation',rows:[['N Wall',`${o.north_wall_length_m} m`],['S Wall',`${o.south_wall_length_m} m`],['E Wall',`${o.east_wall_length_m} m`],['W Wall',`${o.west_wall_length_m} m`],['S Shading',o.has_shading_south?'‚úÖ Yes':'‚ùå No'],['W Shading',o.has_shading_west?'‚úÖ Yes':'‚ùå No']]},
      {label:'Envelope',rows:[['Wall U',`${env.wall_u_value} W/m¬≤K`],['Roof U',`${env.roof_u_value} W/m¬≤K`],['Glazing U',`${env.glazing_u_value} W/m¬≤K`],['SHGC',env.glazing_shgc],['W Glazing',`${env.west_glazing_pct}%`],['S Glazing',`${env.south_glazing_pct}%`]]},
      {label:`‚òÄÔ∏è ${srcFull.split(' ')[0]} Solar ¬∑ ${MN[mo]} ¬∑ ${hr}:00`,rows:[['Sun Alt',`${sol.alt.toFixed(1)}¬∞`],['Azimuth',`${sol.az.toFixed(1)}¬∞`],['North',`${facades.North.total} W/m¬≤`],['East',`${facades.East.total} W/m¬≤`],['South',`${facades.South.total} W/m¬≤`],['West',`${facades.West.total} W/m¬≤`],['Roof',`${facades.Roof.total} W/m¬≤`]]},
      {label:'Internal & Climate',rows:[['Outdoor DBT',`${city.dbt}¬∞C`],['Outdoor WBT',`${city.wbt}¬∞C`],['Indoor','24¬∞C/55%RH'],['Occupancy',`${int_.occupancy_density_m2_per_person} m¬≤/p`],['Lighting',`${int_.lighting_w_per_m2} W/m¬≤`],['Equipment',`${int_.equipment_w_per_m2} W/m¬≤`]]},
    ];
    const gd=document.getElementById('dataGrid');gd.innerHTML='';
    cards.forEach(card=>{const el=document.createElement('div');el.className='dc';el.innerHTML=`<div class="dc-lbl">${card.label}</div>${card.rows.map(([k,v])=>`<div class="dr"><span class="dk">${k}</span><span class="dv ed" contenteditable="true" spellcheck="false">${v??'‚Äî'}</span></div>`).join('')}`;gd.appendChild(el);});
  },500);
}

function computeLoad(){
  const city=getCity('citySelect'),mo=parseInt(document.getElementById('monthSelect').value),hr=parseInt(document.getElementById('hourSelect').value);
  let sr=lastSol;if(!sr){const g=geoAll(city.lat,city.lon,mo,hr,city.alt);sr={sol:g.sol,facades:g.facades,hourly:geoHr(city.lat,city.lon,mo,city.alt),source:'geometry',conf:srcConf('geometry')};}
  const{sol,facades,hourly,source:solSrc,conf:solConf}=sr,d=exData,g=d.geometry||{},o=d.orientation||{},env=d.envelope||{},int_=d.internal||{};
  const fa=g.total_floor_area_m2||4000,fp=g.floor_plate_area_m2||800;env.num_floors=g.num_floors||5;
  let zones=getZones();if(!zones.length)zones=d.zones||defZones(fp,g.num_floors||5,env.west_glazing_pct||30,env.south_glazing_pct||25);
  const{zones:zr,tT,tS,tI}=calcZones(zones,facades,env,int_,city,o);
  const tV=calcVent(fa,city,int_),total=(tT+tS+tI+tV)*0.85*1.10;
  compR={totalKW:total,totalTR:total/3.517,breakdown:{transmission:tT,solar:tS,internal:tI,ventilation:tV},zones:zr,floorArea:fa,city,mo,hr,sol,facades,hourly,solSrc,solConf,projName:document.getElementById('projName').value||'Commercial Building'};
  showResults();
}

function showResults(){
  showPhase(4);document.getElementById('singleRes').style.display='block';document.getElementById('campusRes').style.display='none';
  const r=compR,city=r.city;
  document.getElementById('totalTR').textContent=r.totalTR.toFixed(1);
  document.getElementById('totalKW').textContent=`${r.totalKW.toFixed(1)} kW ¬∑ ${(r.totalKW/r.floorArea*1000).toFixed(0)} W/m¬≤`;
  document.getElementById('resMeta').innerHTML=`<span class="rtag">üìç <strong>${city.name}</strong></span><span class="rtag">üìÖ <strong>${MN[r.mo]}</strong> ¬∑ <strong>${r.hr}:00 IST</strong></span><span class="rtag">üå° <strong>${city.dbt}¬∞C</strong>/<strong>${city.wbt}¬∞C</strong></span><span class="rtag">‚òÄÔ∏è <strong>${r.sol.alt.toFixed(1)}¬∞</strong></span><span class="rtag">üå§ <strong>${city.zone}</strong></span>`;
  const bd=r.breakdown,bt_=bd.transmission+bd.solar+bd.internal+bd.ventilation;
  document.getElementById('bkGrid').innerHTML=[{icon:'üß±',label:'Transmission',val:bd.transmission,c:'#f97316'},{icon:'‚òÄÔ∏è',label:'Solar Gain',val:bd.solar,c:'#eab308'},{icon:'üë•',label:'Internal',val:bd.internal,c:'#3b82f6'},{icon:'üí®',label:'Ventilation',val:bd.ventilation,c:'#22c55e'}].map(b=>{const p=(b.val/bt_*100).toFixed(0);return`<div class="bkc"><div class="bkc-i">${b.icon}</div><div class="bkc-l">${b.label}</div><div class="bkc-v">${b.val.toFixed(1)}</div><div class="bkc-u">kW ¬∑ ${p}%</div><div class="bkc-b"><div class="bkc-bf" style="width:${p}%;background:${b.c}"></div></div></div>`;}).join('');
  document.getElementById('resSolLbl').textContent=`${city.name} ¬∑ ${MN[r.mo]} ¬∑ ${{openmeteo:'Open-Meteo ERA5',pvgis:'PVGIS-SARAH3',geometry:'Blanco-Muriel'}[r.solSrc]||'computed'}`;
  renderBars('resHrChart','resPkMark',r.hourly||geoHr(city.lat,city.lon,r.mo,city.alt),r.hr,r.solSrc||'geometry');
  const hl=v=>v<150?'hl':v<400?'hm':v<600?'hh':'hvh',hlt=v=>v<150?'Low':v<400?'Moderate':v<600?'High':'Very High';
  document.getElementById('solTbl').innerHTML=[{d:'North',k:'North'},{d:'East',k:'East'},{d:'South',k:'South'},{d:'West',k:'West'},{d:'Roof',k:'Roof'}].map(f=>{const fr=r.facades[f.k];return`<tr><td><strong>${f.d}</strong></td><td class="c">${r.sol.alt.toFixed(1)}</td><td class="c">${r.sol.az.toFixed(1)}</td><td class="c">${fr.direct}</td><td class="c">${fr.diffuse}</td><td class="c"><span class="hc ${hl(fr.total)}">${fr.total}</span></td><td class="c"><span class="hc ${hl(fr.total)}">${hlt(fr.total)}</span></td></tr>`;}).join('');
  document.getElementById('zoneTbl').innerHTML=r.zones.map(z=>`<tr><td>${z.name}</td><td>${z.area.toFixed(0)}</td><td>${z.trans.toFixed(2)}</td><td>${z.solar.toFixed(2)}</td><td>${z.internal.toFixed(2)}</td><td>${z.total.toFixed(2)}</td><td><span class="trbdg">${z.tr.toFixed(1)}</span></td></tr>`).join('');
  const env=exData.envelope||{},recs=[];
  if((env.roof_u_value||3.8)>1.5)recs.push({i:'üè†',t:'Add Roof Insulation',d:`Roof receives ${r.facades.Roof.total} W/m¬≤ in ${MN[r.mo]}. 50mm EPS + cool roof (SRI>90) cuts load 20‚Äì30%.`,s:'18‚Äì25'});
  if((env.west_glazing_pct||30)>20)recs.push({i:'ü™ü',t:'Reduce West Glazing',d:`West facade: ${r.facades.West.total} W/m¬≤ at ${r.hr}:00 IST. Limit to <20%, add fins, or use SHGC<0.25.`,s:'10‚Äì15'});
  if((env.glazing_shgc||0.55)>0.4)recs.push({i:'‚òÄÔ∏è',t:'Upgrade to Low-E Glazing',d:`SHGC ${env.glazing_shgc} is high for ${city.zone}. Low-E (SHGC 0.25‚Äì0.30) cuts solar gain 45‚Äì55%.`,s:'12‚Äì18'});
  if(city.zone==='Warm & Humid')recs.push({i:'üíß',t:'Latent Load Priority',d:`${city.name} has high humidity (WBT ${city.wbt}¬∞C). DOAS with energy recovery wheels recommended.`,s:null});
  if(city.zone==='Hot & Dry')recs.push({i:'üí®',t:'Evaporative Pre-cooling',d:`${city.name}'s dry WBT ${city.wbt}¬∞C makes evaporative pre-cooling viable ‚Äî 12‚Äì20% load reduction.`,s:'12‚Äì20'});
  recs.push({i:'üìä',t:'Dynamic Energy Simulation',d:`Validate with HAP/eQUEST/EnergyPlus using TMY3 for ${city.name} for ECBC compliance and final equipment sizing.`,s:null});
  document.getElementById('recList').innerHTML=recs.map(r=>`<div class="ri"><div class="ri-i">${r.i}</div><div class="ri-t"><h5>${r.t}</h5><p>${r.d}</p></div>${r.s?`<span class="sav">‚àí${r.s}%</span>`:''}</div>`).join('');
  const sfn={openmeteo:'Open-Meteo ERA5 Reanalysis API',pvgis:'PVGIS-SARAH3 Satellite API',geometry:'Blanco-Muriel+Hottel Model'}[r.solSrc]||'Solar engine';
  document.getElementById('assNote').innerHTML=`Per <strong>ISHRAE Handbook</strong> / <strong>NBC Part 8</strong>. Solar: <strong>${sfn}</strong> ¬∑ Confidence <strong style="color:${r.solConf?.color}">${r.solConf?.label} (${r.solConf?.score}%)</strong> ‚Äî ${r.solConf?.note||''}. Outdoor <strong>${city.dbt}¬∞C DBT/${city.wbt}¬∞C WBT</strong>. Indoor <strong>24¬∞C/55%RH</strong>. Occupancy 130W/person. Diversity 0.85 ¬∑ Safety 10%. Planning estimate ‚Äî verify with licensed MEP engineer.`;
}

// ‚îÄ‚îÄ CAMPUS COMPUTE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function computeCampus(){
  const blds=getCampusBlds();if(!blds.length){showToast('Add at least one building');return;}
  const city=getCity('campusCitySelect'),mo=parseInt(document.getElementById('campusMonth').value),hr=parseInt(document.getElementById('campusHour').value);
  showToast('Computing campus loads‚Ä¶');
  let sr;try{sr=await fetchSolar(city,mo,hr);}catch(e){const g=geoAll(city.lat,city.lon,mo,hr,city.alt);sr={sol:g.sol,facades:g.facades,hourly:geoHr(city.lat,city.lon,mo,city.alt),source:'geometry',conf:srcConf('geometry')};}
  const results=blds.map(b=>{
    const zones=defZones(b.fp,b.floors,b.wgp,b.sgp);
    const env={wall_u_value:wU[b.wallType]||2.1,roof_u_value:rU[b.roofType]||3.8,glazing_u_value:gU[b.glazingType]||2.8,glazing_shgc:shgcM[b.glazingType]||0.55,wall_absorptivity:0.5,num_floors:b.floors};
    const int_={occupancy_density_m2_per_person:occD[b.type]||10,lighting_w_per_m2:litW[b.type]||12,equipment_w_per_m2:eqW[b.type]||20,fresh_air_cfm_per_person:10};
    const{tT,tS,tI}=calcZones(zones,sr.facades,env,int_,city,{});
    const tV=calcVent(b.totalArea,city,int_),total=(tT+tS+tI+tV)*0.85*1.10;
    return{...b,tT,tS,tI,tV,totalKW:total,totalTR:total/3.517};
  });
  campR={buildings:results,city,mo,hr,sr,campusName:document.getElementById('campusName').value||'Campus Project'};
  showCampusResults();
}

function showCampusResults(){
  const r=campR;showPhase(4);document.getElementById('singleRes').style.display='none';document.getElementById('campusRes').style.display='block';
  const totTR=r.buildings.reduce((a,b)=>a+b.totalTR,0),totKW=r.buildings.reduce((a,b)=>a+b.totalKW,0),totA=r.buildings.reduce((a,b)=>a+b.totalArea,0);
  document.getElementById('campusTR').textContent=totTR.toFixed(1);
  document.getElementById('campusKW').textContent=`${totKW.toFixed(1)} kW total ¬∑ ${(totKW/totA*1000).toFixed(0)} W/m¬≤ avg ¬∑ ${r.buildings.length} buildings`;
  document.getElementById('campusMeta').innerHTML=`<span class="rtag">üìç <strong>${r.city.name}</strong></span><span class="rtag">üìÖ <strong>${MN[r.mo]}</strong> ¬∑ <strong>${r.hr}:00 IST</strong></span><span class="rtag">üèó <strong>${r.buildings.length} Buildings</strong></span><span class="rtag">üìê <strong>${totA.toLocaleString()} m¬≤</strong></span>`;
  const cols=['#f97316','#3b82f6','#22c55e','#eab308','#ef4444','#a855f7','#06b6d4','#ec4899'];
  document.getElementById('campusCards').innerHTML=r.buildings.map((b,i)=>`<div class="crc"><div style="position:absolute;top:0;left:0;right:0;height:2px;background:${cols[i%cols.length]}"></div><div style="font-family:var(--mn);font-size:10px;letter-spacing:1.5px;color:var(--tx3);margin-bottom:8px">${b.name.toUpperCase()}</div><div class="cr-tr">${b.totalTR.toFixed(1)} <span style="font-size:14px;color:var(--ac)">TR</span></div><div style="font-size:12px;color:var(--tx2);margin-bottom:8px">${b.totalKW.toFixed(1)} kW ¬∑ ${b.totalArea.toLocaleString()} m¬≤</div><div style="font-size:11px;color:var(--tx3);font-family:var(--mn)">${b.floors}F ¬∑ ${b.type} ¬∑ ${(b.totalKW/b.totalArea*1000).toFixed(0)} W/m¬≤</div></div>`).join('');
  document.getElementById('campusTbl').innerHTML=r.buildings.map(b=>`<tr><td>${b.name}</td><td>${b.type}</td><td>${b.totalArea.toLocaleString()}</td><td>${b.tT.toFixed(1)}</td><td>${b.tS.toFixed(1)}</td><td>${b.tI.toFixed(1)}</td><td>${b.tV.toFixed(1)}</td><td>${b.totalKW.toFixed(1)}</td><td><span class="trbdg">${b.totalTR.toFixed(1)}</span></td></tr>`).join('');
  document.getElementById('campusFoot').innerHTML=`<tr><td colspan="2"><strong>CAMPUS TOTAL</strong></td><td><strong>${totA.toLocaleString()}</strong></td><td><strong>${r.buildings.reduce((a,b)=>a+b.tT,0).toFixed(1)}</strong></td><td><strong>${r.buildings.reduce((a,b)=>a+b.tS,0).toFixed(1)}</strong></td><td><strong>${r.buildings.reduce((a,b)=>a+b.tI,0).toFixed(1)}</strong></td><td><strong>${r.buildings.reduce((a,b)=>a+b.tV,0).toFixed(1)}</strong></td><td><strong>${totKW.toFixed(1)}</strong></td><td><span class="trbdg" style="font-size:14px">${totTR.toFixed(1)}</span></td></tr>`;
  document.getElementById('campusRecs').innerHTML=`<div class="ri"><div class="ri-i">‚ö°</div><div class="ri-t"><h5>Central Plant vs Distributed</h5><p>Campus load of ${totTR.toFixed(0)} TR warrants central chiller plant evaluation (water-cooled centrifugal). Typical 15‚Äì20% better COP at campus scale vs distributed VRF.</p></div></div><div class="ri"><div class="ri-i">üîó</div><div class="ri-t"><h5>District Cooling &amp; Thermal Storage</h5><p>Chilled water loop with ice/CW tanks shifts ${(totKW*0.3).toFixed(0)} kW of peak load to off-peak, cutting peak plant size 20‚Äì30%.</p></div></div><div class="ri"><div class="ri-i">üìä</div><div class="ri-t"><h5>Campus Diversity Factor</h5><p>Not all ${r.buildings.length} buildings peak simultaneously. Campus diversity is typically 0.75‚Äì0.85. Run full dynamic simulation to right-size central plant.</p></div></div>`;
}

// ‚îÄ‚îÄ PDF EXPORT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function generatePDF(){
  const btn=document.getElementById('pdfBtn'),ico=document.getElementById('pdfIco');
  btn.disabled=true;ico.innerHTML='<span class="spin"></span>';
  try{
    const isCampus=campR&&document.getElementById('campusRes').style.display!=='none';
    const html=isCampus?buildCampusPDF():buildSinglePDF();
    const win=window.open('','_blank','width=1000,height=750');
    win.document.write(html);win.document.close();win.focus();
    setTimeout(()=>{win.print();},900);
  }catch(e){showToast('PDF error: '+e.message);}
  btn.disabled=false;ico.innerHTML='üìÑ';
}

function pdfCSS(){return`<style>*{box-sizing:border-box;margin:0;padding:0;font-family:'Segoe UI',Arial,sans-serif}body{background:white;color:#1a1a1a}@page{size:A4;margin:16mm 14mm}@media print{.np{display:none}.pb{page-break-after:always}}.cover{background:linear-gradient(135deg,#0a0c0f,#1a1410);color:white;padding:40px;position:relative;overflow:hidden}.cover::after{content:'';position:absolute;bottom:-40px;right:-40px;width:180px;height:180px;background:rgba(249,115,22,.1);border-radius:50%}.ctag{font-family:monospace;font-size:10px;letter-spacing:2px;color:#f97316;text-transform:uppercase;margin-bottom:10px}.ch1{font-size:24px;font-weight:700;margin-bottom:6px}.csub{font-size:12px;color:#aaa;margin-bottom:16px}.cmeta{display:flex;flex-wrap:wrap;gap:10px;font-size:11px;color:#888}.cmeta span strong{color:#f97316}.ctotal{position:absolute;right:40px;top:36px;text-align:right}.ctr{font-size:48px;font-weight:700;color:#f97316;line-height:1;font-family:monospace}.ctr-l{font-size:12px;color:#888;font-family:monospace;letter-spacing:2px;margin-top:2px}.ckw{font-size:14px;color:#ccc;font-family:monospace;margin-top:4px}h2{font-size:11px;letter-spacing:2px;text-transform:uppercase;color:#f97316;margin:18px 0 10px;border-bottom:1px solid #e5e5e5;padding-bottom:5px;font-family:monospace}.kpi{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:16px}.kc{border:1px solid #e5e5e5;border-radius:7px;padding:12px;border-top:3px solid}.kl{font-size:10px;text-transform:uppercase;letter-spacing:1px;color:#888;margin-bottom:6px}.kv{font-size:20px;font-weight:700;font-family:monospace}.ku{font-size:10px;color:#aaa;font-family:monospace;margin-top:2px}table{width:100%;border-collapse:collapse;font-size:10.5px;margin-bottom:14px}th{background:#f5f5f5;padding:7px 9px;text-align:left;font-size:9px;letter-spacing:1px;text-transform:uppercase;color:#666;border-bottom:2px solid #e0e0e0}th.c,td.c{text-align:center}td{padding:7px 9px;border-bottom:1px solid #f0f0f0}tr:nth-child(even) td{background:#fafafa}tfoot td{background:#fff8f4;font-weight:700;border-top:2px solid #f97316}.bdg{display:inline-block;padding:2px 7px;border-radius:4px;font-size:10px;font-family:monospace;font-weight:700}.bo{background:#fff3e8;color:#f97316}.bg{background:#e8f9ee;color:#16a34a}.by{background:#fefce8;color:#ca8a04}.br{background:#fef2f2;color:#dc2626}.igrid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px}.ib{border:1px solid #e5e5e5;border-radius:7px;padding:12px}.ib h3{font-size:9px;letter-spacing:1px;text-transform:uppercase;color:#888;margin-bottom:8px;font-family:monospace}.ir{display:flex;justify-content:space-between;padding:4px 0;border-bottom:1px solid #f5f5f5;font-size:11px}.ir:last-child{border:none}.ik{color:#666}.iv{font-family:monospace;font-weight:600}.rec{display:flex;gap:10px;padding:10px 12px;border:1px solid #f0f0f0;border-radius:6px;margin-bottom:8px;font-size:11px}.ri{font-size:16px;flex-shrink:0}.rt h5{font-size:12px;margin-bottom:3px;font-weight:600}.rt p{color:#666;line-height:1.5}.sv{margin-left:auto;flex-shrink:0;font-size:10px;font-family:monospace;color:#16a34a;background:#e8f9ee;border:1px solid #bbf7d0;border-radius:4px;padding:2px 7px}.disc{background:#fff8f4;border-left:3px solid #f97316;padding:10px 14px;font-size:10px;color:#666;margin-top:12px;border-radius:0 4px 4px 0;line-height:1.6}.foot{margin-top:18px;padding-top:10px;border-top:1px solid #e0e0e0;font-size:10px;color:#999;display:flex;justify-content:space-between}.bldgrid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:16px}.bc{border:1px solid #e0e0e0;border-radius:8px;padding:14px;border-top:3px solid #f97316}.bcn{font-size:10px;text-transform:uppercase;letter-spacing:1px;color:#888;margin-bottom:6px}.bcv{font-size:22px;font-weight:700;color:#f97316;font-family:monospace}.bcs{font-size:11px;color:#666;margin-top:2px}</style>`;}

function buildSinglePDF(){
  const r=compR,city=r.city,dt=new Date().toLocaleDateString('en-IN',{day:'2-digit',month:'long',year:'numeric'});
  const sfn={openmeteo:'Open-Meteo ERA5',pvgis:'PVGIS-SARAH3',geometry:'Blanco-Muriel+Hottel'}[r.solSrc]||'Solar engine';
  const env=exData.envelope||{},int_=exData.internal||{};
  const bd=r.breakdown,bt_=bd.transmission+bd.solar+bd.internal+bd.ventilation;
  const hl=v=>v<150?'bg':v<400?'by':v<600?'bo':'br',hlt=v=>v<150?'Low':v<400?'Moderate':v<600?'High':'Very High';
  return`<!DOCTYPE html><html><head><meta charset="UTF-8"><title>${r.projName} ‚Äî Heat Load Report</title>${pdfCSS()}</head><body>
<div class="cover">
  <div class="ctag">ThermalScan ¬∑ Heat Load Calculation Report</div>
  <div class="ch1">${r.projName}</div>
  <div class="csub">${city.name}, ${city.state} ¬∑ ${city.zone} Climate</div>
  <div class="cmeta">
    <span>üìç <strong>${city.name}</strong> (${city.lat}¬∞N, ${city.lon}¬∞E, ${city.alt}m)</span>
    <span>üìÖ <strong>${MN[r.mo]} ${r.hr}:00 IST</strong></span>
    <span>üå° <strong>${city.dbt}¬∞C DBT / ${city.wbt}¬∞C WBT</strong></span>
    <span>‚òÄÔ∏è Sun <strong>${r.sol.alt.toFixed(1)}¬∞</strong> alt</span>
    <span>üìê <strong>${r.floorArea.toLocaleString()} m¬≤</strong></span>
    <span>üóì ${dt}</span>
  </div>
  <div class="ctotal"><div class="ctr">${r.totalTR.toFixed(1)}</div><div class="ctr-l">TOTAL TR</div><div class="ckw">${r.totalKW.toFixed(0)} kW</div></div>
</div>
<div style="padding:18px 0">
<h2>Load Summary</h2>
<div class="kpi">
  <div class="kc" style="border-top-color:#f97316"><div class="kl">Total Cooling Load</div><div class="kv" style="color:#f97316">${r.totalTR.toFixed(1)}</div><div class="ku">TR (${r.totalKW.toFixed(0)} kW)</div></div>
  <div class="kc" style="border-top-color:#3b82f6"><div class="kl">Load Density</div><div class="kv" style="color:#3b82f6">${(r.totalKW/r.floorArea*1000).toFixed(0)}</div><div class="ku">W/m¬≤ conditioned area</div></div>
  <div class="kc" style="border-top-color:#22c55e"><div class="kl">Conditioned Area</div><div class="kv" style="color:#22c55e">${r.floorArea.toLocaleString()}</div><div class="ku">m¬≤ total floor area</div></div>
  <div class="kc" style="border-top-color:#eab308"><div class="kl">West Facade Solar</div><div class="kv" style="color:#eab308">${r.facades.West.total}</div><div class="ku">W/m¬≤ @ design hour</div></div>
</div>
<h2>Load Breakdown</h2>
<table><thead><tr><th>Component</th><th>kW</th><th>TR</th><th>%</th></tr></thead><tbody>
${[{n:'Transmission (Envelope)',v:bd.transmission,c:'#f97316'},{n:'Solar Heat Gain',v:bd.solar,c:'#eab308'},{n:'Internal Loads (Occ+Light+Equip)',v:bd.internal,c:'#3b82f6'},{n:'Ventilation (Sensible+Latent)',v:bd.ventilation,c:'#22c55e'}].map(b=>{const p=(b.v/bt_*100).toFixed(0);return`<tr><td><strong>${b.n}</strong></td><td>${b.v.toFixed(1)}</td><td>${(b.v/3.517).toFixed(1)}</td><td><span style="display:inline-block;width:${Math.min(p,100)}%;height:8px;background:${b.c};border-radius:4px;vertical-align:middle;margin-right:4px"></span>${p}%</td></tr>`;}).join('')}
<tr style="font-weight:700;background:#f5f5f5"><td>TOTAL (Diversity 0.85 √ó Safety 1.10)</td><td>${r.totalKW.toFixed(1)}</td><td>${r.totalTR.toFixed(1)}</td><td>100%</td></tr>
</tbody></table>
<div class="igrid">
  <div class="ib"><h3>Solar Irradiance @ Design Hour ‚Äî ${sfn}</h3>${[['North',r.facades.North.total],['East',r.facades.East.total],['South',r.facades.South.total],['West',r.facades.West.total],['Roof',r.facades.Roof.total]].map(([k,v])=>`<div class="ir"><span class="ik">${k}</span><span class="iv">${v} W/m¬≤</span></div>`).join('')}</div>
  <div class="ib"><h3>Design Conditions</h3>${[['City',`${city.name}, ${city.state}`],['Lat / Lon',`${city.lat}¬∞N, ${city.lon}¬∞E`],['Altitude',`${city.alt} m`],['Climate Zone',city.zone],['Outdoor DBT',`${city.dbt}¬∞C`],['Outdoor WBT',`${city.wbt}¬∞C`],['Indoor','24¬∞C / 55% RH'],['Solar Confidence',`${r.solConf?.label} (${r.solConf?.score}%)`]].map(([k,v])=>`<div class="ir"><span class="ik">${k}</span><span class="iv">${v}</span></div>`).join('')}</div>
</div>
<h2>Zone-wise Distribution</h2>
<table><thead><tr><th>Zone</th><th>Area m¬≤</th><th>Trans kW</th><th>Solar kW</th><th>Internal kW</th><th>Total kW</th><th>TR</th></tr></thead><tbody>
${r.zones.map(z=>`<tr><td>${z.name}</td><td>${z.area.toFixed(0)}</td><td>${z.trans.toFixed(2)}</td><td>${z.solar.toFixed(2)}</td><td>${z.internal.toFixed(2)}</td><td>${z.total.toFixed(2)}</td><td><span class="bdg bo">${z.tr.toFixed(1)} TR</span></td></tr>`).join('')}
</tbody></table>
<h2>Facade Solar Analysis</h2>
<table><thead><tr><th>Facade</th><th>Direct W/m¬≤</th><th>Diffuse W/m¬≤</th><th>Total W/m¬≤</th><th>Level</th></tr></thead><tbody>
${[{d:'North',f:r.facades.North},{d:'East',f:r.facades.East},{d:'South',f:r.facades.South},{d:'West',f:r.facades.West},{d:'Roof',f:r.facades.Roof}].map(({d,f})=>`<tr><td><strong>${d}</strong></td><td>${f.direct}</td><td>${f.diffuse}</td><td><strong>${f.total}</strong></td><td><span class="bdg ${hl(f.total)}">${hlt(f.total)}</span></td></tr>`).join('')}
</tbody></table>
<div class="disc">Standard: ISHRAE Handbook / NBC Part 8. Solar irradiance source: ${sfn} ¬∑ Confidence: ${r.solConf?.label} (${r.solConf?.score}%) ‚Äî ${r.solConf?.note}. Outdoor: ${city.dbt}¬∞C DBT / ${city.wbt}¬∞C WBT. Indoor: 24¬∞C / 55% RH. Occupancy 130W/person ¬∑ Lighting ${int_.lighting_w_per_m2||12}W/m¬≤ ¬∑ Equipment ${int_.equipment_w_per_m2||20}W/m¬≤ ¬∑ Fresh air 10 CFM/person. Diversity factor 0.85 ¬∑ Safety margin 10%. Planning-level estimate only ‚Äî engage a licensed MEP engineer for detailed design.</div>
<div class="foot"><span>ThermalScan ¬∑ Powered by ShrviTech</span><span>${dt}</span></div>
</div></body></html>`;}

function buildCampusPDF(){
  const r=campR,city=r.city,dt=new Date().toLocaleDateString('en-IN',{day:'2-digit',month:'long',year:'numeric'});
  const totTR=r.buildings.reduce((a,b)=>a+b.totalTR,0),totKW=r.buildings.reduce((a,b)=>a+b.totalKW,0),totA=r.buildings.reduce((a,b)=>a+b.totalArea,0);
  return`<!DOCTYPE html><html><head><meta charset="UTF-8"><title>${r.campusName} ‚Äî Campus Heat Load</title>${pdfCSS()}</head><body>
<div class="cover">
  <div class="ctag">ThermalScan ¬∑ Campus Heat Load Report</div>
  <div class="ch1">${r.campusName}</div>
  <div class="csub">${city.name}, ${city.state} ¬∑ ${r.buildings.length} Buildings</div>
  <div class="cmeta">
    <span>üìç <strong>${city.name}</strong></span>
    <span>üìÖ <strong>${MN[r.mo]} ${r.hr}:00 IST</strong></span>
    <span>üå° <strong>${city.dbt}¬∞C DBT / ${city.wbt}¬∞C WBT</strong></span>
    <span>üèó <strong>${r.buildings.length} Buildings</strong> ¬∑ <strong>${totA.toLocaleString()} m¬≤</strong></span>
    <span>üóì ${dt}</span>
  </div>
  <div class="ctotal"><div class="ctr">${totTR.toFixed(1)}</div><div class="ctr-l">TOTAL TR</div><div class="ckw">${totKW.toFixed(0)} kW</div></div>
</div>
<div style="padding:18px 0">
<h2>Building Summary</h2>
<div class="bldgrid">${r.buildings.map(b=>`<div class="bc"><div class="bcn">${b.name}</div><div class="bcv">${b.totalTR.toFixed(1)} TR</div><div class="bcs">${b.totalKW.toFixed(0)} kW ¬∑ ${b.totalArea.toLocaleString()} m¬≤<br>${b.floors}F ¬∑ ${b.type} ¬∑ ${(b.totalKW/b.totalArea*1000).toFixed(0)} W/m¬≤</div></div>`).join('')}</div>
<h2>Campus Load Distribution</h2>
<table><thead><tr><th>Building</th><th>Type</th><th>Area m¬≤</th><th>Trans kW</th><th>Solar kW</th><th>Internal kW</th><th>Vent kW</th><th>Total kW</th><th>TR</th></tr></thead>
<tbody>${r.buildings.map(b=>`<tr><td>${b.name}</td><td>${b.type}</td><td>${b.totalArea.toLocaleString()}</td><td>${b.tT.toFixed(1)}</td><td>${b.tS.toFixed(1)}</td><td>${b.tI.toFixed(1)}</td><td>${b.tV.toFixed(1)}</td><td><strong>${b.totalKW.toFixed(1)}</strong></td><td><strong>${b.totalTR.toFixed(1)}</strong></td></tr>`).join('')}</tbody>
<tfoot><tr><td colspan="2"><strong>CAMPUS TOTAL</strong></td><td><strong>${totA.toLocaleString()}</strong></td><td><strong>${r.buildings.reduce((a,b)=>a+b.tT,0).toFixed(1)}</strong></td><td><strong>${r.buildings.reduce((a,b)=>a+b.tS,0).toFixed(1)}</strong></td><td><strong>${r.buildings.reduce((a,b)=>a+b.tI,0).toFixed(1)}</strong></td><td><strong>${r.buildings.reduce((a,b)=>a+b.tV,0).toFixed(1)}</strong></td><td><strong>${totKW.toFixed(1)}</strong></td><td><strong style="color:#f97316;font-size:14px">${totTR.toFixed(1)} TR</strong></td></tr></tfoot>
</table>
<div class="disc">Per ISHRAE Handbook / NBC Part 8. Outdoor: ${city.dbt}¬∞C DBT / ${city.wbt}¬∞C WBT. Indoor: 24¬∞C / 55% RH. Diversity 0.85 ¬∑ Safety 10%. Planning-level estimate ‚Äî engage a licensed MEP engineer for detailed design.</div>
<div class="foot"><span>ThermalScan ¬∑ Powered by ShrviTech</span><span>${dt}</span></div>
</div></body></html>`;}

// ‚îÄ‚îÄ TXT DOWNLOAD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function downloadTXT(){
  const isCampus=campR&&document.getElementById('campusRes').style.display!=='none';
  let txt='';
  if(isCampus){
    const r=campR,totTR=r.buildings.reduce((a,b)=>a+b.totalTR,0),totKW=r.buildings.reduce((a,b)=>a+b.totalKW,0);
    txt=`THERMALSCAN ‚Äî CAMPUS HEAT LOAD REPORT\nPowered by ShrviTech\n${'‚ïê'.repeat(55)}\nCampus: ${r.campusName}\nCity: ${r.city.name} | ${MN[r.mo]} ${r.hr}:00 IST\nTotal: ${totTR.toFixed(1)} TR (${totKW.toFixed(1)} kW)\n\nBUILDING BREAKDOWN:\n${r.buildings.map(b=>`  ${b.name}: ${b.totalTR.toFixed(1)} TR (${b.totalKW.toFixed(1)} kW) ‚Äî ${b.floors}F ${b.totalArea}m¬≤`).join('\n')}\n\nDISCLAIMER: Planning-level estimate. Verify with licensed MEP engineer.`;
  }else{
    const r=compR,city=r.city;
    txt=`THERMALSCAN ‚Äî HEAT LOAD REPORT\nPowered by ShrviTech\n${'‚ïê'.repeat(55)}\nProject: ${r.projName}\nCity: ${city.name} (${city.lat}¬∞N, ${city.lon}¬∞E, ${city.alt}m)\nClimate: ${city.zone} | DBT ${city.dbt}¬∞C / WBT ${city.wbt}¬∞C\nDesign: ${MN[r.mo]} ${r.hr}:00 IST\nSun: ${r.sol.alt.toFixed(1)}¬∞ alt, ${r.sol.az.toFixed(1)}¬∞ az\nSolar source: ${{openmeteo:'Open-Meteo ERA5',pvgis:'PVGIS-SARAH3',geometry:'Blanco-Muriel+Hottel'}[r.solSrc]} (${r.solConf?.score}% confidence)\nDate: ${new Date().toLocaleDateString('en-IN')}\n${'‚îÄ'.repeat(55)}\nTOTAL HEAT LOAD: ${r.totalTR.toFixed(1)} TR (${r.totalKW.toFixed(1)} kW)\nLoad Density: ${(r.totalKW/r.floorArea*1000).toFixed(0)} W/m¬≤\n\nBREAKDOWN:\n  Transmission: ${r.breakdown.transmission.toFixed(1)} kW\n  Solar Gain:   ${r.breakdown.solar.toFixed(1)} kW\n  Internal:     ${r.breakdown.internal.toFixed(1)} kW\n  Ventilation:  ${r.breakdown.ventilation.toFixed(1)} kW\n\nSOLAR IRRADIANCE:\n  North: ${r.facades.North.total} W/m¬≤\n  East:  ${r.facades.East.total} W/m¬≤\n  South: ${r.facades.South.total} W/m¬≤\n  West:  ${r.facades.West.total} W/m¬≤\n  Roof:  ${r.facades.Roof.total} W/m¬≤\n\nZONE LOADS:\n${r.zones.map(z=>`  ${z.name}: ${z.total.toFixed(1)} kW (${z.tr.toFixed(1)} TR)`).join('\n')}\n\nDiversity: 0.85 | Safety: 10%\nDISCLAIMER: Planning-level estimate. Verify with licensed MEP engineer.`;
  }
  const a=document.createElement('a');a.href='data:text/plain;charset=utf-8,'+encodeURIComponent(txt);a.download='ThermalScan_Report.txt';a.click();
}

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
populateCities();showPhase(1);
console.log('[ThermalScan v4] Ready ‚Äî Open-Meteo + PVGIS + Blanco-Muriel | Campus + Zone Editor | PDF Export');
</script>
</body>
</html>